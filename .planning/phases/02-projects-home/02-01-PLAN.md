---
phase: 02-projects-home
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/projects.ts
  - next.config.js
autonomous: true

must_haves:
  truths:
    - "Convex schema defines projects table with all required fields"
    - "Convex queries return project data with screenshot URLs"
    - "Next.js Image component can load Convex-hosted images"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Projects table definition with indexes"
      contains: "projects: defineTable"
    - path: "convex/projects.ts"
      provides: "Project queries (list, getBySlug, filterByTech)"
      exports: ["list", "getBySlug", "filterByTech"]
    - path: "next.config.js"
      provides: "remotePatterns for Convex CDN"
      contains: "*.convex.cloud"
  key_links:
    - from: "convex/projects.ts"
      to: "convex/schema.ts"
      via: "schema type import"
      pattern: 'query\\("projects"\\)'
---

<objective>
Create Convex data model and queries for projects, plus configure Next.js for Convex image hosting.

Purpose: Foundation for all project display functionality - schema defines data structure, queries provide data access, remotePatterns enables optimized image loading.
Output: Working Convex backend for projects with image URL resolution.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-projects-home/02-RESEARCH.md

Existing files to reference:
@convex/schema.ts (current placeholder schema)
@next.config.js (current basic config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add projects table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Update convex/schema.ts to add projects table with these fields:

- name: v.string() - project display name
- slug: v.string() - URL-safe identifier (e.g., "wpdesigner")
- description: v.string() - one-line description for cards
- descriptionLong: v.optional(v.string()) - full description for detail page
- screenshotId: v.optional(v.id("_storage")) - reference to Convex storage (optional for initial setup without images)
- status: v.union(v.literal("live"), v.literal("archived"), v.literal("in-progress"))
- techStack: v.array(v.string()) - flat array of all techs for filtering
- techCategories: v.object({ frontend: v.array(v.string()), backend: v.array(v.string()), infrastructure: v.array(v.string()) }) - categorized for display
- liveUrl: v.optional(v.string())
- githubUrl: v.optional(v.string())
- featured: v.boolean() - for home page featuring
- displayOrder: v.number() - for sorting/reordering
- createdAt: v.number() - timestamp

Add indexes:
- .index("by_slug", ["slug"]) - for detail page lookup
- .index("by_featured", ["featured"]) - for home page query
- .index("by_order", ["displayOrder"]) - for sorted listing

Keep the existing healthChecks table for infrastructure verification.
  </action>
  <verify>Run `bunx convex dev --once` in Docker container or locally - schema should push without errors</verify>
  <done>Projects table exists in Convex with all fields and 3 indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex project queries</name>
  <files>convex/projects.ts</files>
  <action>
Create convex/projects.ts with these queries:

1. `list` query (no args):
   - Fetch all projects using withIndex("by_order")
   - Order descending by displayOrder
   - For each project, resolve screenshotId to URL using ctx.storage.getUrl() (handle null gracefully)
   - Return array with screenshotUrl added to each project

2. `getBySlug` query (args: { slug: v.string() }):
   - Query projects using withIndex("by_slug", q => q.eq("slug", args.slug))
   - Get first() result
   - Return null if not found
   - If found, resolve screenshotUrl and return project with URL

3. `filterByTech` query (args: { techs: v.array(v.string()) }):
   - Fetch all projects (Convex doesn't support array intersection with indexes)
   - Filter client-side: keep projects where any techStack item is in args.techs
   - If techs array is empty, return all projects
   - Resolve screenshotUrls for filtered results
   - Return filtered array with screenshotUrls

For screenshotId handling: If screenshotId is null/undefined, set screenshotUrl to null (don't call storage.getUrl with undefined).

Import from "./_generated/server" for query function.
Import { v } from "convex/values" for args validation.
  </action>
  <verify>Run `bunx convex dev --once` - should compile without type errors. Verify exports appear in convex/_generated/api.d.ts</verify>
  <done>Three queries exported: list, getBySlug, filterByTech - all handle optional screenshotId gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Configure Next.js for Convex image hosting</name>
  <files>next.config.js</files>
  <action>
Update next.config.js to add images.remotePatterns for Convex CDN:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.convex.cloud',
        pathname: '/api/storage/**',
      },
    ],
  },
};

module.exports = nextConfig;
```

This allows Next.js Image component to optimize and serve images from Convex's storage CDN.

Note: Using wildcard *.convex.cloud to support both production (amicable-pony-588.convex.cloud) and any other Convex deployments.
  </action>
  <verify>Run `bun run build` - should complete without image configuration errors</verify>
  <done>next.config.js has remotePatterns for *.convex.cloud with /api/storage/** pathname</done>
</task>

</tasks>

<verification>
1. Schema verification: `bunx convex dev --once` pushes schema successfully
2. Query verification: convex/_generated/api.d.ts shows projects.list, projects.getBySlug, projects.filterByTech
3. Build verification: `bun run build` completes without errors
4. Type verification: `bun run type-check` passes
</verification>

<success_criteria>
- Convex schema includes projects table with all specified fields and 3 indexes
- Three project queries exported and type-safe
- Next.js configured to serve Convex-hosted images via Image component
- All builds and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-projects-home/02-01-SUMMARY.md`
</output>
