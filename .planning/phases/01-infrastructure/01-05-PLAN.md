---
phase: 01-infrastructure
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - .github/workflows/ci.yml
  - vercel.json
autonomous: false
user_setup:
  - service: github
    why: "Code hosting and CI/CD"
    env_vars: []
    dashboard_config:
      - task: "Create repository on GitHub"
        location: "github.com/new"
      - task: "Add remote origin"
        location: "Terminal: git remote add origin https://github.com/USER/REPO.git"
      - task: "Set develop as default branch"
        location: "GitHub -> Settings -> Branches -> Default branch"
      - task: "Enable branch protection on main"
        location: "GitHub -> Settings -> Branches -> Add rule for main"
  - service: vercel
    why: "Production deployment"
    env_vars:
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "Already have from Convex setup - same value as .env.local"
    dashboard_config:
      - task: "Import project from GitHub"
        location: "vercel.com/new -> Import Git Repository"
      - task: "Set production branch to main"
        location: "Vercel -> Project Settings -> Git -> Production Branch"
      - task: "Disable auto-deploy for develop"
        location: "Vercel -> Project Settings -> Git -> Ignored Build Step"

must_haves:
  truths:
    - "GitHub Actions runs lint, type-check, and build on every PR"
    - "Vercel deploys only when merged to main branch"
    - "PRs cannot merge to main without passing CI checks"
    - "develop is the default working branch"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow for PR validation"
      contains: "lint-typecheck-build"
    - path: "vercel.json"
      provides: "Vercel deployment configuration"
      contains: "deploymentEnabled"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "bun run commands"
      pattern: "bun run lint"
    - from: "vercel.json"
      to: "main branch"
      via: "deployment config"
      pattern: "main.*true"
---

<objective>
Configure GitHub Actions CI and Vercel deployment with branch protection.

Purpose: Ensures code quality through automated checks and controlled production deployments. Only tested, approved code reaches production.
Output: Working CI pipeline, Vercel deployment on main only, and branch protection rules.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
    Create .github/workflows/ci.yml:

    ```yaml
    name: CI

    on:
      pull_request:
        branches: ['**']

    jobs:
      lint-typecheck-build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup Bun
            uses: oven-sh/setup-bun@v1
            with:
              bun-version: latest

          - name: Install dependencies
            run: bun install --frozen-lockfile

          - name: Run ESLint
            run: bun run lint

          - name: Type check
            run: bun run type-check

          - name: Build
            run: bun run build
            env:
              NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}

    ```

    Key aspects per CONTEXT.md decisions:
    - Runs on ALL PRs (branches: ['**']), not just PRs to main
    - Single job: lint-typecheck-build (name used for branch protection)
    - Uses Bun (not npm) per global conventions
    - Requires NEXT_PUBLIC_CONVEX_URL secret for build step
    - Steps: checkout -> setup bun -> install -> lint -> type-check -> build
  </action>
  <verify>
    .github/workflows/ci.yml exists
    Contains lint, type-check, and build steps
    Uses bun, not npm
    Triggers on all PRs (branches: ['**'])
  </verify>
  <done>
    GitHub Actions CI workflow created that runs lint, type-check, and build on every PR
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Vercel deployment configuration</name>
  <files>
    vercel.json
  </files>
  <action>
    Create vercel.json to control deployment behavior:

    ```json
    {
      "$schema": "https://openapi.vercel.sh/vercel.json",
      "git": {
        "deploymentEnabled": {
          "main": true,
          "develop": false
        }
      },
      "github": {
        "enabled": true,
        "autoAlias": true
      },
      "framework": "nextjs",
      "buildCommand": "bun run build",
      "installCommand": "bun install"
    }
    ```

    Key aspects:
    - Deploys only on main branch merges
    - Disables auto-deploy for develop branch
    - Uses bun for install and build commands
    - Framework set to nextjs for optimal defaults

    Commit CI and Vercel config:
    `git add .github/workflows/ci.yml vercel.json`
    `git commit -m "feat(infra): add GitHub Actions CI and Vercel config

    - CI runs lint, type-check, build on all PRs
    - Vercel deploys only on merge to main
    - Bun used for all package operations"`
  </action>
  <verify>
    vercel.json exists with deploymentEnabled config
    main is true, develop is false
    buildCommand uses bun
  </verify>
  <done>
    Vercel configured to deploy only on main branch merges, not develop
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Setup GitHub repository and connect Vercel</action>
  <why>
    Creating the GitHub repository and connecting to Vercel requires account access and dashboard configuration.
    These steps need human interaction with external services.
  </why>
  <instructions>
    ## Step 1: Create GitHub Repository

    1. Go to github.com/new
    2. Repository name: wpdesigner (or preferred name)
    3. Description: "Portfolio website for jpgerton.com"
    4. Private or Public: Your choice
    5. Do NOT initialize with README (we have existing code)
    6. Click "Create repository"

    ## Step 2: Connect Local Repository

    Run these commands:
    ```bash
    git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
    git push -u origin main
    git push -u origin develop
    ```

    ## Step 3: Set develop as Default Branch

    1. Go to GitHub repo -> Settings -> Branches
    2. Under "Default branch", click the switch icon
    3. Select "develop"
    4. Click "Update" and confirm

    ## Step 4: Add Branch Protection to main

    1. Go to Settings -> Branches -> Add branch ruleset (or Add rule)
    2. Branch name pattern: main
    3. Enable:
       - Require a pull request before merging
       - Require status checks to pass before merging
       - Add required check: "lint-typecheck-build"
       - Require branches to be up to date before merging
    4. Save changes

    ## Step 5: Add CI Secret

    1. Go to Settings -> Secrets and variables -> Actions
    2. Click "New repository secret"
    3. Name: NEXT_PUBLIC_CONVEX_URL
    4. Value: (paste your Convex deployment URL from .env.local)
    5. Click "Add secret"

    ## Step 6: Connect to Vercel

    1. Go to vercel.com/new
    2. Import Git Repository
    3. Select your GitHub repo
    4. Framework Preset: Next.js (auto-detected)
    5. Build Command: bun run build (auto from vercel.json)
    6. Install Command: bun install (auto from vercel.json)
    7. Add Environment Variable:
       - Name: NEXT_PUBLIC_CONVEX_URL
       - Value: (same as .env.local)
    8. Click "Deploy"

    ## Step 7: Verify Vercel Settings

    1. After deploy, go to Project Settings -> Git
    2. Confirm Production Branch is "main"
    3. Confirm develop is not being deployed (check "Ignored Build Step" if needed)

    Type "done" when all steps are complete
  </instructions>
  <resume-signal>Type "done" after GitHub and Vercel are configured</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify CI/CD pipeline and create test PR</name>
  <files>None (verification only)</files>
  <action>
    1. Create a test branch from develop:
       `git checkout develop`
       `git checkout -b feat/verify-ci`

    2. Make a minor change (e.g., update page title in app/page.tsx):
       Add or modify a comment or minor text change

    3. Commit and push:
       `git add app/page.tsx`
       `git commit -m "test: verify CI pipeline"`
       `git push -u origin feat/verify-ci`

    4. Create PR via GitHub CLI or web:
       `gh pr create --title "test: Verify CI pipeline" --body "Testing GitHub Actions CI workflow runs correctly."`

       Or via GitHub web interface: Create PR from feat/verify-ci to develop

    5. Verify CI runs:
       - Go to PR page
       - Check "Checks" tab
       - Wait for "lint-typecheck-build" job to complete
       - Should show green checkmark

    6. Merge the PR (after CI passes):
       - Click "Merge pull request"
       - Delete the test branch

    7. Create PR from develop to main:
       `git checkout develop`
       `git pull origin develop`
       `gh pr create --base main --title "feat: Phase 1 Infrastructure" --body "Complete infrastructure setup including Docker, Convex, Tailwind, and CI/CD."`

    8. Verify:
       - CI runs on the PR to main
       - After merge to main, Vercel deploys automatically
       - develop commits alone do NOT trigger Vercel deploy

    9. Check Vercel deployment:
       - Go to Vercel dashboard
       - Verify deployment triggered only after merge to main
       - Visit production URL to confirm site works

    10. Final commit to develop (cleanup):
        `git checkout develop`
        `git pull origin develop`
  </action>
  <verify>
    CI workflow runs on PR (check GitHub Actions tab)
    CI passes: lint, type-check, build all green
    Branch protection prevents merge without passing CI
    Vercel deploys after merge to main
    Production site accessible at Vercel URL
  </verify>
  <done>
    CI/CD pipeline fully verified - PRs require passing checks, Vercel deploys on main merge only
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 1 success criteria from ROADMAP.md:

1. `docker compose up` starts the entire dev environment on ports 3400-3499 - VERIFIED
2. Code changes on host filesystem reflect immediately in running containers - VERIFIED
3. No direct `bun dev` or `npx convex dev` on host - all execution through Docker - VERIFIED
4. Next.js app renders with Tailwind styles and shadcn/ui components working - VERIFIED
5. Convex backend connects successfully with type-safe queries - VERIFIED
6. User can toggle between dark and light mode with preference persisting - VERIFIED
7. Application deploys to Vercel only when merged to main branch - VERIFIED
8. GitHub repo has develop branch as default working branch, main branch protected - VERIFIED
9. GitHub Actions runs lint, type-check, and build on every PR - VERIFIED
10. PRs require passing checks before merge to main is allowed - VERIFIED
</verification>

<success_criteria>
- GitHub Actions CI runs on every PR (lint, type-check, build)
- CI checks required to pass before merge to main
- develop is default working branch
- main branch is protected
- Vercel deploys automatically on merge to main
- Vercel does NOT deploy on develop commits
- Production site accessible
- Phase 1 complete!
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-05-SUMMARY.md`
</output>
