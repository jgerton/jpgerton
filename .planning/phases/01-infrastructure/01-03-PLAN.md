---
phase: 01-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - convex/schema.ts
  - convex/_generated/api.d.ts
  - convex/_generated/dataModel.d.ts
  - app/providers.tsx
  - app/layout.tsx
  - docker-compose.yml
  - package.json
  - .env.local
autonomous: false
user_setup:
  - service: convex
    why: "Backend database and real-time sync"
    env_vars:
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "Convex Dashboard after running `npx convex dev` - deployment URL shown in terminal"
      - name: CONVEX_DEPLOYMENT
        source: "Convex Dashboard -> Project Settings -> Deployment slug"
    dashboard_config:
      - task: "Create Convex project (auto on first `convex dev`)"
        location: "Terminal - follow prompts during convex dev"

must_haves:
  truths:
    - "Convex backend connects from Next.js frontend"
    - "Type-safe queries can be executed from React components"
    - "Convex dev server syncs schema changes in development"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Database schema definition"
      contains: "defineSchema"
    - path: "app/providers.tsx"
      provides: "Client-side provider wrapper"
      contains: "ConvexProvider"
    - path: "package.json"
      provides: "Convex dependency"
      contains: "convex"
  key_links:
    - from: "app/providers.tsx"
      to: "process.env.NEXT_PUBLIC_CONVEX_URL"
      via: "ConvexReactClient initialization"
      pattern: "new ConvexReactClient"
    - from: "app/layout.tsx"
      to: "app/providers.tsx"
      via: "Providers component import"
      pattern: "import.*Providers"
---

<objective>
Integrate Convex backend with type-safe queries.

Purpose: Establishes the backend infrastructure for all data operations - projects, contact forms, admin content management.
Output: Convex connected to Next.js with working type generation and a minimal schema for verification.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex and create schema</name>
  <files>
    package.json
    convex/schema.ts
  </files>
  <action>
    1. Install Convex:
       `bun add convex`

    2. Create convex/schema.ts with a minimal placeholder schema:
       ```typescript
       import { defineSchema, defineTable } from "convex/server";
       import { v } from "convex/values";

       export default defineSchema({
         // Placeholder table for infrastructure verification
         // Real tables (projects, contacts) added in later phases
         _placeholder: defineTable({
           message: v.string(),
           createdAt: v.number(),
         }),
       });
       ```

    This placeholder schema:
    - Validates Convex is working
    - Will be replaced with real tables in Phase 2 (projects) and Phase 3 (contacts)
    - Allows type generation to proceed

    3. Create convex/functions/health.ts for connection verification:
       ```typescript
       import { query } from "../_generated/server";

       export const check = query({
         args: {},
         handler: async () => {
           return { status: "ok", timestamp: Date.now() };
         },
       });
       ```
  </action>
  <verify>
    convex/schema.ts exists with defineSchema
    package.json includes convex dependency
  </verify>
  <done>
    Convex installed with minimal schema for infrastructure verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Providers wrapper and connect frontend</name>
  <files>
    app/providers.tsx
    app/layout.tsx
  </files>
  <action>
    Create app/providers.tsx as a Client Component:
    ```tsx
    "use client";

    import { ConvexProvider, ConvexReactClient } from "convex/react";
    import { ReactNode } from "react";

    const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

    export function Providers({ children }: { children: ReactNode }) {
      return (
        <ConvexProvider client={convex}>
          {children}
        </ConvexProvider>
      );
    }
    ```

    Update app/layout.tsx to wrap children with Providers:
    ```tsx
    import { Inter } from "next/font/google";
    import "./globals.css";
    import { Providers } from "./providers";

    const inter = Inter({
      subsets: ["latin"],
      display: "swap",
      variable: "--font-inter",
    });

    export const metadata = {
      title: "jpgerton.com",
      description: "Web development services by Jon Gerton",
    };

    export default function RootLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      return (
        <html lang="en" className={inter.variable}>
          <body className="font-sans">
            <Providers>{children}</Providers>
          </body>
        </html>
      );
    }
    ```

    Key points:
    - Providers is "use client" (ConvexProvider uses React Context)
    - layout.tsx stays as Server Component
    - NEXT_PUBLIC_CONVEX_URL loaded from environment
    - ThemeProvider will be added in Plan 04 (inside Providers)
  </action>
  <verify>
    app/providers.tsx exists with "use client" directive
    app/layout.tsx imports and uses Providers
  </verify>
  <done>
    ConvexProvider wrapped in Client Component, imported by Server Component layout
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Initialize Convex project and get deployment URL</action>
  <why>
    Convex requires interactive authentication and project creation on first run.
    This creates the cloud deployment and generates NEXT_PUBLIC_CONVEX_URL.
  </why>
  <instructions>
    1. Run Convex initialization (on host, not in Docker - one-time setup):
       `bunx convex dev`

    2. Follow the prompts:
       - Select "Create a new project" if first time
       - Name it "jpgerton" or similar
       - Authenticate via browser if prompted

    3. Copy the deployment URL shown in terminal output
       (looks like: https://adjective-animal-123.convex.cloud)

    4. Update .env.local with the URL:
       ```
       NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
       CONVEX_DEPLOYMENT=your-deployment-slug
       ```

    5. Leave `bunx convex dev` running in a terminal tab (watches schema changes)
       Or stop it for now - we'll run it via Docker Compose later.

    Type "done" when .env.local has NEXT_PUBLIC_CONVEX_URL set
  </instructions>
  <resume-signal>Type "done" after setting NEXT_PUBLIC_CONVEX_URL in .env.local</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify Convex connection and commit</name>
  <files>
    app/page.tsx
  </files>
  <action>
    1. Update app/page.tsx to verify Convex connection:
       ```tsx
       "use client";

       import { useQuery } from "convex/react";
       import { api } from "@/convex/_generated/api";

       export default function Home() {
         const health = useQuery(api.functions.health.check);

         return (
           <main className="flex min-h-screen flex-col items-center justify-center p-24">
             <h1 className="text-4xl font-bold mb-8">jpgerton.com</h1>
             <div className="text-lg">
               {health ? (
                 <p className="text-green-600">
                   Convex connected: {health.status} at {new Date(health.timestamp).toLocaleTimeString()}
                 </p>
               ) : (
                 <p className="text-yellow-600">Connecting to Convex...</p>
               )}
             </div>
           </main>
         );
       }
       ```

    2. Restart Docker environment to pick up new env vars:
       `docker compose down && docker compose up --build`

    3. Verify in browser at http://localhost:3400:
       - Should show "Convex connected: ok" with timestamp
       - If shows "Connecting..." check NEXT_PUBLIC_CONVEX_URL is set

    4. Commit Convex integration:
       `git add convex/ app/providers.tsx app/layout.tsx app/page.tsx package.json bun.lockb`
       `git commit -m "feat(infra): integrate Convex backend

       - Convex schema with placeholder table
       - ConvexProvider in client component wrapper
       - Health check query for connection verification
       - Type-safe API generation working"`
  </action>
  <verify>
    http://localhost:3400 shows "Convex connected: ok"
    convex/_generated/ directory exists with type definitions
    `bun run build` succeeds with Convex integrated
  </verify>
  <done>
    Convex fully integrated with type-safe queries working from frontend
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Convex deployment exists with schema pushed
2. http://localhost:3400 shows Convex connection status
3. convex/_generated/api.d.ts has typed API exports
4. useQuery(api.functions.health.check) returns data
5. All changes committed to develop branch
</verification>

<success_criteria>
- Convex connected and serving queries
- Type generation working (api object is fully typed)
- Frontend displays connection verification
- Schema changes sync automatically in development
- Ready for styling integration in Plan 04
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-03-SUMMARY.md`
</output>
