---
phase: 19-launch-prep-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/analytics.ts
  - components/portfolio/cta-button.tsx
  - components/calendly/calendly-button.tsx
  - components/forms/contact-form.tsx
autonomous: true

must_haves:
  truths:
    - "CTA button clicks fire GA4 cta_click events with button name and page location"
    - "Calendly popup opens fire GA4 cta_click events with 'book_a_call' button name"
    - "Contact form submissions fire GA4 form_submit events with 'contact' form name"
    - "Analytics functions are no-ops when GA4 is not loaded (dev/preview environments)"
  artifacts:
    - path: "lib/analytics.ts"
      provides: "GA4 custom event tracking functions"
      exports: ["trackCTAClick", "trackFormSubmit"]
    - path: "components/portfolio/cta-button.tsx"
      provides: "CTAButton with onClick analytics tracking"
      exports: ["CTAButton", "ctaButtonVariants"]
    - path: "components/calendly/calendly-button.tsx"
      provides: "CalendlyButton with popup open tracking"
      exports: ["CalendlyButton"]
    - path: "components/forms/contact-form.tsx"
      provides: "ContactForm with submission tracking"
      exports: ["ContactForm"]
  key_links:
    - from: "components/portfolio/cta-button.tsx"
      to: "lib/analytics.ts"
      via: "import trackCTAClick"
      pattern: "import.*trackCTAClick.*from.*lib/analytics"
    - from: "components/calendly/calendly-button.tsx"
      to: "lib/analytics.ts"
      via: "import trackCTAClick"
      pattern: "import.*trackCTAClick.*from.*lib/analytics"
    - from: "components/forms/contact-form.tsx"
      to: "lib/analytics.ts"
      via: "import trackFormSubmit"
      pattern: "import.*trackFormSubmit.*from.*lib/analytics"
---

<objective>
Add GA4 custom event tracking to all key conversion points on the site.

Purpose: Track user engagement with CTA buttons ("Book a Call", "Get Your Business Online", etc.), Calendly popup opens, and contact form submissions. This data enables understanding which pages and CTAs drive conversions.

Output: Analytics utility library + event tracking wired into CTAButton, CalendlyButton, and ContactForm
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-launch-prep-tech-debt/19-CONTEXT.md
@.planning/phases/19-launch-prep-tech-debt/19-RESEARCH.md
@components/portfolio/cta-button.tsx
@components/calendly/calendly-button.tsx
@components/forms/contact-form.tsx
@types/gtag.d.ts
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics utility library</name>
  <files>lib/analytics.ts</files>
  <action>
Create `lib/analytics.ts` with GA4 custom event tracking functions.

All functions must guard against SSR and missing gtag (when NEXT_PUBLIC_GA_ID is not set):
```
if (typeof window !== "undefined" && window.gtag) { ... }
```

Functions to create:

1. `trackCTAClick(buttonName: string, metadata?: { page_section?: string })` - fires `cta_click` event with:
   - `button_name`: the name of the button clicked (e.g., "book_a_call", "get_your_business_online", "view_portfolio")
   - `page_location`: window.location.href
   - `page_section`: optional section identifier

2. `trackFormSubmit(formName: string, metadata?: { project_type?: string })` - fires `form_submit` event with:
   - `form_name`: the form submitted (e.g., "contact")
   - `page_location`: window.location.href
   - `project_type`: optional, for the contact form project type selection

GA4 event naming rules to follow:
- Use lowercase snake_case for event names and parameter names
- Event names start with letter, only letters/numbers/underscores
- Parameter name max 40 chars, value max 100 chars

Do NOT create a separate file for type definitions - the existing `types/gtag.d.ts` already declares `window.gtag`.
  </action>
  <verify>
Run `bun run type-check` to confirm the module compiles and the gtag types are compatible.
  </verify>
  <done>
`lib/analytics.ts` exports trackCTAClick and trackFormSubmit, both with SSR/gtag guards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire event tracking into CTAButton, CalendlyButton, and ContactForm</name>
  <files>components/portfolio/cta-button.tsx, components/calendly/calendly-button.tsx, components/forms/contact-form.tsx</files>
  <action>
Wire analytics tracking into the three key conversion components.

**CTAButton (`components/portfolio/cta-button.tsx`):**
- This component needs to become a client component - add `"use client"` directive at top
- Import `trackCTAClick` from `@/lib/analytics`
- Add an optional `trackingName` prop to CTAButtonProps (type: `string | undefined`)
- In the forwardRef render, wrap the existing onClick behavior: when clicked, call `trackCTAClick(trackingName || "unnamed_cta")` then call any existing `onClick` from props
- Pattern: `onClick={(e) => { if (trackingName) trackCTAClick(trackingName); props.onClick?.(e); }}`
- Important: CTAButton is used with `asChild` + Link in many places. When `asChild=true`, the onClick is passed through to the child via Slot. This means the tracking fires when the Link is clicked.
- Do NOT break the existing forwardRef pattern or CVA variants

**CalendlyButton (`components/calendly/calendly-button.tsx`):**
- Already a client component
- Import `trackCTAClick` from `@/lib/analytics`
- Add tracking before the PopupButton renders. Since PopupButton is from react-calendly and we cannot easily add onClick to it, fire the tracking event when the component mounts with an interaction: use the existing `mounted` state and add tracking in a wrapper onClick on the parent. Actually, the simplest approach: wrap the PopupButton in a div with `onClick={() => trackCTAClick("book_a_call")}` and let the event bubble. The popup button click will propagate up.
- Keep all existing functionality (UTM params, dynamic import, SSR guard)

**ContactForm (`components/forms/contact-form.tsx`):**
- Already a client component
- Import `trackFormSubmit` from `@/lib/analytics`
- In the existing `onSubmit` function, AFTER the successful `createContact` call (after the `if (!result.success)` check), before the router.push, call: `trackFormSubmit("contact", { project_type: data.projectType })`
- Only track successful submissions, not failed ones
  </action>
  <verify>
Run `bun run type-check` to confirm no TypeScript errors. Run `bun run lint` to confirm no ESLint issues. Run `bun run build` to confirm the build succeeds with the new client directive on CTAButton.
  </verify>
  <done>
- CTAButton fires cta_click event on click when trackingName is provided
- CalendlyButton fires cta_click event with "book_a_call" on popup open
- ContactForm fires form_submit event with form name and project type on successful submission
- All tracking is conditional on GA4 being loaded (safe in dev/preview)
- Build passes
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. `lib/analytics.ts` exports trackCTAClick and trackFormSubmit
5. CTAButton has "use client" directive and trackingName prop
6. CalendlyButton calls trackCTAClick on popup interaction
7. ContactForm calls trackFormSubmit after successful submission
8. No analytics code runs when window.gtag is undefined
</verification>

<success_criteria>
- All three conversion components (CTAButton, CalendlyButton, ContactForm) fire appropriate GA4 events
- Analytics functions gracefully no-op when GA4 is not configured
- Existing component behavior is preserved (no regressions in CTA links, Calendly popups, form submissions)
- Build and type-check pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-launch-prep-tech-debt/19-02-SUMMARY.md`
</output>
