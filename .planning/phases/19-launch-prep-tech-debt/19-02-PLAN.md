---
phase: 19-launch-prep-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/analytics.ts
  - components/portfolio/cta-button.tsx
  - components/calendly/calendly-button.tsx
  - components/forms/contact-form.tsx
  - components/blog/blog-read-tracker.tsx
  - components/blog/category-filter.tsx
  - app/blog/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "CTA button clicks fire GA4 cta_click events with button name and page location"
    - "Calendly popup opens fire GA4 cta_click events with 'book_a_call' button name"
    - "Contact form submissions fire GA4 form_submit events with 'contact' form name"
    - "Category filter clicks on /blog fire GA4 blog_category_filter events with the selected category"
    - "Reaching the end of a blog post on /blog/[slug] fires a GA4 blog_read_complete event with the post slug and reading time"
    - "Analytics functions are no-ops when GA4 is not loaded (dev/preview environments)"
  artifacts:
    - path: "lib/analytics.ts"
      provides: "GA4 custom event tracking functions"
      exports: ["trackCTAClick", "trackFormSubmit", "trackBlogCategoryFilter", "trackBlogReadComplete"]
    - path: "components/portfolio/cta-button.tsx"
      provides: "CTAButton with onClick analytics tracking"
      exports: ["CTAButton", "ctaButtonVariants"]
    - path: "components/calendly/calendly-button.tsx"
      provides: "CalendlyButton with popup open tracking"
      exports: ["CalendlyButton"]
    - path: "components/forms/contact-form.tsx"
      provides: "ContactForm with submission tracking"
      exports: ["ContactForm"]
    - path: "components/blog/blog-read-tracker.tsx"
      provides: "Client component that fires blog_read_complete when article end is reached"
      exports: ["BlogReadTracker"]
    - path: "components/blog/category-filter.tsx"
      provides: "CategoryFilter with category click tracking"
      exports: ["CategoryFilter"]
  key_links:
    - from: "components/portfolio/cta-button.tsx"
      to: "lib/analytics.ts"
      via: "import trackCTAClick"
      pattern: "import.*trackCTAClick.*from.*lib/analytics"
    - from: "components/calendly/calendly-button.tsx"
      to: "lib/analytics.ts"
      via: "import trackCTAClick"
      pattern: "import.*trackCTAClick.*from.*lib/analytics"
    - from: "components/forms/contact-form.tsx"
      to: "lib/analytics.ts"
      via: "import trackFormSubmit"
      pattern: "import.*trackFormSubmit.*from.*lib/analytics"
    - from: "components/blog/category-filter.tsx"
      to: "lib/analytics.ts"
      via: "import trackBlogCategoryFilter"
      pattern: "import.*trackBlogCategoryFilter.*from.*lib/analytics"
    - from: "components/blog/blog-read-tracker.tsx"
      to: "lib/analytics.ts"
      via: "import trackBlogReadComplete"
      pattern: "import.*trackBlogReadComplete.*from.*lib/analytics"
    - from: "app/blog/[slug]/page.tsx"
      to: "components/blog/blog-read-tracker.tsx"
      via: "BlogReadTracker placed as sentinel at end of article"
      pattern: "<BlogReadTracker"
---

<objective>
Add GA4 custom event tracking to all key conversion points and blog engagement signals on the site.

Purpose: Track user engagement with CTA buttons ("Book a Call", "Get Your Business Online", etc.), Calendly popup opens, contact form submissions, blog category filter usage, and blog read-through completion. This data enables understanding which pages and CTAs drive conversions, and how visitors engage with blog content.

Output: Analytics utility library + event tracking wired into CTAButton, CalendlyButton, ContactForm, CategoryFilter, and blog detail pages
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-launch-prep-tech-debt/19-CONTEXT.md
@.planning/phases/19-launch-prep-tech-debt/19-RESEARCH.md
@components/portfolio/cta-button.tsx
@components/calendly/calendly-button.tsx
@components/forms/contact-form.tsx
@components/blog/category-filter.tsx
@components/blog/blog-post-content.tsx
@app/blog/[slug]/page.tsx
@hooks/use-intersection-observer.ts
@types/gtag.d.ts
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics utility library</name>
  <files>lib/analytics.ts</files>
  <action>
Create `lib/analytics.ts` with GA4 custom event tracking functions.

All functions must guard against SSR and missing gtag (when NEXT_PUBLIC_GA_ID is not set):
```
if (typeof window !== "undefined" && window.gtag) { ... }
```

Functions to create:

1. `trackCTAClick(buttonName: string, metadata?: { page_section?: string })` - fires `cta_click` event with:
   - `button_name`: the name of the button clicked (e.g., "book_a_call", "get_your_business_online", "view_portfolio")
   - `page_location`: window.location.href
   - `page_section`: optional section identifier

2. `trackFormSubmit(formName: string, metadata?: { project_type?: string })` - fires `form_submit` event with:
   - `form_name`: the form submitted (e.g., "contact")
   - `page_location`: window.location.href
   - `project_type`: optional, for the contact form project type selection

3. `trackBlogCategoryFilter(category: string)` - fires `blog_category_filter` event with:
   - `category`: the category selected (e.g., "Web Design", "Business Tips"), or "all" if the "All" button was clicked
   - `page_location`: window.location.href

4. `trackBlogReadComplete(slug: string, readTimeMinutes: number)` - fires `blog_read_complete` event with:
   - `post_slug`: the blog post slug
   - `read_time_minutes`: the estimated reading time from the post metadata
   - `page_location`: window.location.href

GA4 event naming rules to follow:
- Use lowercase snake_case for event names and parameter names
- Event names start with letter, only letters/numbers/underscores
- Parameter name max 40 chars, value max 100 chars

Do NOT create a separate file for type definitions - the existing `types/gtag.d.ts` already declares `window.gtag`.
  </action>
  <verify>
Run `bun run type-check` to confirm the module compiles and the gtag types are compatible.
  </verify>
  <done>
`lib/analytics.ts` exports trackCTAClick, trackFormSubmit, trackBlogCategoryFilter, and trackBlogReadComplete, all with SSR/gtag guards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire event tracking into CTAButton, CalendlyButton, and ContactForm</name>
  <files>components/portfolio/cta-button.tsx, components/calendly/calendly-button.tsx, components/forms/contact-form.tsx</files>
  <action>
Wire analytics tracking into the three key conversion components.

**CTAButton (`components/portfolio/cta-button.tsx`):**
- This component needs to become a client component - add `"use client"` directive at top
- Import `trackCTAClick` from `@/lib/analytics`
- Add an optional `trackingName` prop to CTAButtonProps (type: `string | undefined`)
- In the forwardRef render, wrap the existing onClick behavior: when clicked, call `trackCTAClick(trackingName || "unnamed_cta")` then call any existing `onClick` from props
- Pattern: `onClick={(e) => { if (trackingName) trackCTAClick(trackingName); props.onClick?.(e); }}`
- Important: CTAButton is used with `asChild` + Link in many places. When `asChild=true`, the onClick is passed through to the child via Slot. This means the tracking fires when the Link is clicked.
- Do NOT break the existing forwardRef pattern or CVA variants

**CalendlyButton (`components/calendly/calendly-button.tsx`):**
- Already a client component
- Import `trackCTAClick` from `@/lib/analytics`
- Add tracking before the PopupButton renders. Since PopupButton is from react-calendly and we cannot easily add onClick to it, fire the tracking event when the component mounts with an interaction: use the existing `mounted` state and add tracking in a wrapper onClick on the parent. Actually, the simplest approach: wrap the PopupButton in a div with `onClick={() => trackCTAClick("book_a_call")}` and let the event bubble. The popup button click will propagate up.
- Keep all existing functionality (UTM params, dynamic import, SSR guard)

**ContactForm (`components/forms/contact-form.tsx`):**
- Already a client component
- Import `trackFormSubmit` from `@/lib/analytics`
- In the existing `onSubmit` function, AFTER the successful `createContact` call (after the `if (!result.success)` check), before the router.push, call: `trackFormSubmit("contact", { project_type: data.projectType })`
- Only track successful submissions, not failed ones
  </action>
  <verify>
Run `bun run type-check` to confirm no TypeScript errors. Run `bun run lint` to confirm no ESLint issues. Run `bun run build` to confirm the build succeeds with the new client directive on CTAButton.
  </verify>
  <done>
- CTAButton fires cta_click event on click when trackingName is provided
- CalendlyButton fires cta_click event with "book_a_call" on popup open
- ContactForm fires form_submit event with form name and project type on successful submission
- All tracking is conditional on GA4 being loaded (safe in dev/preview)
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire blog engagement tracking into CategoryFilter and blog detail page</name>
  <files>components/blog/category-filter.tsx, components/blog/blog-read-tracker.tsx, app/blog/[slug]/page.tsx</files>
  <action>
Wire blog engagement analytics into the category filter and blog detail pages per the CONTEXT.md locked decision for blog engagement tracking.

**CategoryFilter (`components/blog/category-filter.tsx`):**
- Already a client component ("use client" at top)
- Import `trackBlogCategoryFilter` from `@/lib/analytics`
- In each button's onClick handler, fire the tracking event BEFORE calling `onCategoryChange`
- For the "All" button: `trackBlogCategoryFilter("all")`
- For category buttons: `trackBlogCategoryFilter(category)`
- This is a simple addition to the existing onClick handlers - do NOT restructure the component

**BlogReadTracker (`components/blog/blog-read-tracker.tsx`) - NEW FILE:**
- Create a small "use client" component that acts as a sentinel for read completion
- Props: `slug: string`, `readTimeMinutes: number`
- Uses the existing `useIntersectionObserver` hook from `@/hooks/use-intersection-observer` with `{ threshold: 0.5, triggerOnce: true }`
- When `isVisible` becomes true, call `trackBlogReadComplete(slug, readTimeMinutes)`
- Render a visually hidden div (no visible UI) that the ref attaches to. Use `<div ref={elementRef} aria-hidden="true" />` - this is the sentinel element
- The component fires the event exactly once per page load (triggerOnce: true on the observer)
- Keep it minimal - under 25 lines total

**Blog detail page (`app/blog/[slug]/page.tsx`):**
- This is a Server Component - do NOT add "use client"
- Import `BlogReadTracker` from `@/components/blog/blog-read-tracker`
- Place `<BlogReadTracker slug={slug} readTimeMinutes={post.readingTime} />` AFTER the `<BlogPostContent>` component and BEFORE the bottom CTA div, inside the `<article>` element
- The BlogReadTracker is a client component island inside the server component page - this is the standard Next.js pattern
- Do NOT move or change any other content in the page
  </action>
  <verify>
Run `bun run type-check` to confirm no TypeScript errors. Run `bun run lint` to confirm no ESLint issues. Run `bun run build` to confirm the build succeeds. Verify that `components/blog/blog-read-tracker.tsx` exists and imports from `@/lib/analytics` and `@/hooks/use-intersection-observer`. Verify that `app/blog/[slug]/page.tsx` includes `<BlogReadTracker`.
  </verify>
  <done>
- CategoryFilter fires blog_category_filter event when any category button (including "All") is clicked
- BlogReadTracker component exists as a client component sentinel
- Blog detail page includes BlogReadTracker after article content
- Scrolling to the end of a blog post fires blog_read_complete event exactly once
- All tracking is conditional on GA4 being loaded (safe in dev/preview)
- Build passes
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. `lib/analytics.ts` exports trackCTAClick, trackFormSubmit, trackBlogCategoryFilter, and trackBlogReadComplete
5. CTAButton has "use client" directive and trackingName prop
6. CalendlyButton calls trackCTAClick on popup interaction
7. ContactForm calls trackFormSubmit after successful submission
8. CategoryFilter calls trackBlogCategoryFilter on each category button click
9. BlogReadTracker component exists at components/blog/blog-read-tracker.tsx
10. Blog detail page includes BlogReadTracker after article content
11. No analytics code runs when window.gtag is undefined
</verification>

<success_criteria>
- All three conversion components (CTAButton, CalendlyButton, ContactForm) fire appropriate GA4 events
- Blog engagement is tracked: category filter clicks and read-through completion
- Analytics functions gracefully no-op when GA4 is not configured
- Existing component behavior is preserved (no regressions in CTA links, Calendly popups, form submissions, category filtering, blog reading)
- Build and type-check pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-launch-prep-tech-debt/19-02-SUMMARY.md`
</output>
