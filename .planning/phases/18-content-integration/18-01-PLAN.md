---
phase: 18-content-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/testimonials.ts
autonomous: true

must_haves:
  truths:
    - "Testimonials table exists in Convex with quote, name, title, company, photoId, displayOrder, isDeleted, createdAt fields"
    - "Public query returns non-deleted testimonials ordered by displayOrder ascending"
    - "Seed mutation inserts the 2 existing hardcoded testimonials into the database"
  artifacts:
    - path: "convex/testimonials.ts"
      provides: "Testimonials queries and seed mutation"
      exports: ["list", "seed"]
    - path: "convex/schema.ts"
      provides: "Testimonials table definition"
      contains: "testimonials: defineTable"
  key_links:
    - from: "convex/testimonials.ts"
      to: "convex/schema.ts"
      via: "testimonials table definition"
      pattern: "testimonials"
---

<objective>
Create the Convex testimonials backend: schema table definition, public list query, and seed mutation to populate initial data.

Purpose: The home page currently has 2 hardcoded testimonials. This plan creates the database layer so Plan 03 can swap the hardcoded array for a dynamic query. No admin CRUD UI needed (user decision: manage via Convex dashboard).

Output: `convex/testimonials.ts` with list query and seed mutation, updated `convex/schema.ts` with testimonials table.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-content-integration/18-CONTEXT.md
@.planning/phases/18-content-integration/18-RESEARCH.md

@convex/schema.ts
@convex/blogPosts.ts (reference: query patterns, soft delete, displayOrder)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add testimonials table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a `testimonials` table definition to `convex/schema.ts` after the `caseStudies` table.

Fields:
- `quote: v.string()` - the testimonial quote text
- `name: v.string()` - person's name
- `title: v.string()` - person's job title (e.g., "Owner", "Manager")
- `company: v.string()` - company name
- `photoId: v.optional(v.id("_storage"))` - optional avatar photo
- `displayOrder: v.number()` - for ordering
- `isDeleted: v.boolean()` - soft delete flag
- `createdAt: v.number()` - creation timestamp

Index:
- `.index("by_order", ["displayOrder"])` - for ordered queries

Do NOT add `status` or `publishedAt` fields. Testimonials are simpler than blog/case study publishing - they are either visible (not deleted) or hidden (deleted). This follows the user decision: "Testimonials table is lightweight."
  </action>
  <verify>Run `bun run type-check` inside the Docker container. Schema should compile without errors.</verify>
  <done>Testimonials table definition exists in schema.ts with all specified fields and the by_order index.</done>
</task>

<task type="auto">
  <name>Task 2: Create testimonials queries and seed mutation</name>
  <files>convex/testimonials.ts</files>
  <action>
Create `convex/testimonials.ts` with two exports:

1. **`list` query** (public, no auth required):
   - Query all testimonials from the `testimonials` table using `withIndex("by_order")` ordered ascending
   - Filter out deleted testimonials (`!t.isDeleted`)
   - Resolve `photoId` to `photoUrl` using `ctx.storage.getUrl()` (return null if no photoId)
   - Return array of testimonials with `photoUrl` field added
   - Follow the exact same pattern as `blogPosts.listPublished` and `caseStudies.listPublished`

2. **`seed` mutation** (requires auth):
   - Check if testimonials table already has data (`ctx.db.query("testimonials").first()`) - if data exists, return early with a message like "Testimonials already seeded" to prevent duplicate inserts
   - Insert the 2 existing hardcoded testimonials from the home page:
     ```
     {
       quote: "Jon delivered our website ahead of schedule and it looks incredible. Our phone started ringing the week we launched.",
       name: "Sarah Mitchell",
       title: "Owner",
       company: "Northern Lights Bakery",
       displayOrder: 1,
       isDeleted: false,
       createdAt: Date.now(),
     }
     ```
     ```
     {
       quote: "Finally, a developer who speaks plain English. Jon explained everything clearly and the site does exactly what we need.",
       name: "Marcus Chen",
       title: "Manager",
       company: "Anchorage Auto Detail",
       displayOrder: 2,
       isDeleted: false,
       createdAt: Date.now(),
     }
     ```
   - No `photoId` for either (they currently render with initial-based AvatarFallback)
   - Return the count of inserted testimonials

Import patterns to follow from existing codebase:
```typescript
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";
import { getAuthUserId } from "./auth";
```
  </action>
  <verify>
Run `bun run type-check` inside the Docker container. The new file should compile without errors.
Run `bun run lint` to confirm no lint issues.
  </verify>
  <done>
`convex/testimonials.ts` exists with `list` (public query returning ordered, non-deleted testimonials with resolved photoUrls) and `seed` (authenticated mutation that inserts the 2 hardcoded testimonials, idempotent).
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes with no new errors
2. `bun run lint` passes with no new errors
3. `convex/schema.ts` contains testimonials table with correct fields and index
4. `convex/testimonials.ts` exports `list` and `seed`
5. `list` query is public (no auth check), `seed` mutation requires auth
</verification>

<success_criteria>
- Testimonials table defined in schema with quote, name, title, company, photoId, displayOrder, isDeleted, createdAt
- Public list query returns non-deleted testimonials ordered by displayOrder with resolved photo URLs
- Seed mutation is idempotent and inserts the exact 2 testimonials currently hardcoded in the home page
- All type checks and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-content-integration/18-01-SUMMARY.md`
</output>
