---
phase: 17-public-blog-pages
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - app/blog/[slug]/page.tsx
  - app/blog/[slug]/opengraph-image.tsx
  - components/blog/blog-post-content.tsx
  - app/sitemap.ts
  - components/navigation/site-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /blog/[slug] renders the full blog post with markdown content, syntax-highlighted code blocks, and proper typography"
    - "Draft posts return 404 when accessed directly via URL"
    - "Each blog post page has unique Open Graph metadata (title, description, image)"
    - "Blog posts appear in the sitemap with correct URLs"
    - "Blog link appears in the site navigation"
    - "A book-a-call CTA appears at the bottom of every post"
    - "JSON-LD BlogPosting schema is embedded in each post page"
  artifacts:
    - path: "app/blog/[slug]/page.tsx"
      provides: "Blog post detail page with SSR, metadata, JSON-LD"
    - path: "app/blog/[slug]/opengraph-image.tsx"
      provides: "Dynamic OG image per blog post"
    - path: "components/blog/blog-post-content.tsx"
      provides: "Markdown renderer with syntax highlighting"
    - path: "app/sitemap.ts"
      provides: "Updated sitemap with blog post URLs"
    - path: "components/navigation/site-nav.tsx"
      provides: "Navigation with Blog link"
  key_links:
    - from: "app/blog/[slug]/page.tsx"
      to: "convex/blogPosts.ts:getBySlug"
      via: "fetchQuery(api.blogPosts.getBySlug)"
      pattern: "fetchQuery.*blogPosts\\.getBySlug"
    - from: "components/blog/blog-post-content.tsx"
      to: "app/globals.css:.prose"
      via: "className prose"
      pattern: 'className.*prose'
    - from: "app/sitemap.ts"
      to: "convex/blogPosts.ts:listPublished"
      via: "fetchQuery(api.blogPosts.listPublished)"
      pattern: "fetchQuery.*blogPosts\\.listPublished"
---

<objective>
Create the blog post detail page with server-rendered markdown, syntax highlighting, dynamic OG images, JSON-LD structured data, sitemap integration, and site navigation update.

Purpose: Enable visitors to read individual blog posts with proper typography, code highlighting, and full SEO treatment. Complete the blog discovery story by adding the Blog link to site navigation.

Output: Blog post detail page with markdown rendering, dynamic OG images, JSON-LD Article schema, updated sitemap, and Blog nav link.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-public-blog-pages/17-CONTEXT.md
@.planning/phases/17-public-blog-pages/17-RESEARCH.md
@.planning/phases/17-public-blog-pages/17-01-SUMMARY.md
@.planning/phases/15-content-schema-backend/15-02-SUMMARY.md

Key existing files to reference:
@app/projects/[slug]/page.tsx - Example of fetchQuery SSR + generateMetadata + generateStaticParams pattern
@app/sitemap.ts - Existing sitemap with project pages (add blog posts)
@components/navigation/site-nav.tsx - Nav links array at line 10-16
@convex/blogPosts.ts - getBySlug query (line 128-155), listPublished query (line 73-120)
@lib/site-config.ts - Author info for JSON-LD
@app/globals.css - Prose styles added in Plan 01
@components/portfolio/sections/cta-banner.tsx - CTA pattern reference
@components/portfolio/sections/section-background.tsx - Section wrapper
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blog post detail page with markdown rendering and SEO</name>
  <files>
    app/blog/[slug]/page.tsx
    components/blog/blog-post-content.tsx
  </files>
  <action>
1. **Create `components/blog/blog-post-content.tsx`** - Server Component for markdown rendering:
- NO "use client" directive (Server Component - react-markdown is RSC-compatible)
- Props: `content: string`
- Uses `react-markdown` with `remarkGfm` and `rehypeHighlight` plugins
- Wraps output in a `div` with `className="prose"` (uses custom prose styles from globals.css)
- Import pattern:
```typescript
import Markdown from "react-markdown";
import remarkGfm from "remark-gfm";
import rehypeHighlight from "rehype-highlight";
```
- Pass plugins: `remarkPlugins={[remarkGfm]}` and `rehypePlugins={[rehypeHighlight]}`
- That's it - keep it simple. The CSS cascade in `.prose` handles all styling.

2. **Create `app/blog/[slug]/page.tsx`** - Server Component:
- Follow the EXACT same pattern as `app/projects/[slug]/page.tsx`:
  - `type Props = { params: Promise<{ slug: string }> }` (Next.js 16 pattern)
  - `await params` to get slug
  - `fetchQuery(api.blogPosts.getBySlug, { slug })` for data
  - `notFound()` if post is null (handles drafts and deleted posts - getBySlug already filters these)

- **generateMetadata:**
```typescript
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { slug } = await params;
  try {
    const post = await fetchQuery(api.blogPosts.getBySlug, { slug });
    if (!post) return { title: "Post Not Found" };
    return {
      title: post.title,
      description: post.excerpt,
      openGraph: {
        title: `${post.title} | Jon Gerton`,
        description: post.excerpt,
        type: "article",
        publishedTime: post.publishedAt ? new Date(post.publishedAt).toISOString() : undefined,
        authors: [siteConfig.author.name],
        images: [{ url: `/blog/${slug}/opengraph-image`, width: 1200, height: 630 }],
      },
      twitter: {
        card: "summary_large_image",
        title: post.title,
        description: post.excerpt,
      },
    };
  } catch {
    return { title: "Blog Post" };
  }
}
```

- **Page component layout** (vertical flow per CONTEXT.md):
  1. Full-width cover image hero: Use Next.js `Image` component, `w-full aspect-[2/1] md:aspect-[3/1] object-cover` (wide cinematic ratio). If no cover image, show a gradient placeholder using the SectionBackground gradient colors.
  2. Prose-width content area (`max-w-prose mx-auto px-md py-xl`):
     - Back link: `Link` to `/blog` with ArrowLeft icon, "Back to Blog" text (match projects/[slug] pattern)
     - `h1` with `font-serif font-semibold text-h1 leading-tight mb-sm`: `{post.title}`
     - Meta row: `div` with `flex flex-wrap gap-sm text-sm text-muted-foreground mb-xl`:
       - `Badge variant="secondary"`: `{post.category}`
       - Formatted date: `new Date(post.publishedAt).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })`
       - Separator dot
       - `{post.readingTime} min read`
     - `BlogPostContent content={post.content}` - the markdown renderer
     - Bottom CTA section: `div` with `mt-2xl pt-xl border-t border-border`:
       - `h2` with `font-serif text-h3 leading-snug mb-sm`: "Want a website like this for your business?"
       - `p` with `text-muted-foreground mb-lg`: "I build professional WordPress sites for local businesses, starting at $500. Let's talk about getting your business online."
       - Two CTA buttons in a flex row: CTAButton (intent="warm") linking to /services with "Get Your Business Online", and outline Button linking to /contact with "Book a Free Call"

  3. JSON-LD BlogPosting schema: Embed as `<script type="application/ld+json">` before the `<article>` element:
```typescript
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: post.coverImageUrl ? [post.coverImageUrl] : [],
  datePublished: post.publishedAt ? new Date(post.publishedAt).toISOString() : undefined,
  dateModified: post.publishedAt ? new Date(post.publishedAt).toISOString() : undefined,
  author: [{
    "@type": "Person",
    name: siteConfig.author.name,
    url: siteConfig.url,
  }],
  publisher: {
    "@type": "Person",
    name: siteConfig.author.name,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `${siteConfig.url}/blog/${slug}`,
  },
};
```

- **generateStaticParams** (like projects page):
```typescript
export async function generateStaticParams() {
  try {
    const posts = await fetchQuery(api.blogPosts.listPublished, {});
    return posts.map((post) => ({ slug: post.slug }));
  } catch {
    return [];
  }
}
```

- Required imports: `fetchQuery` from "convex/nextjs", `api` from "@/convex/_generated/api", `Image` from "next/image", `Link` from "next/link", `notFound` from "next/navigation", `Badge` from "@/components/ui/badge", `Button` from "@/components/ui/button", `CTAButton` from "@/components/portfolio/cta-button", `ArrowLeft` from "lucide-react", `siteConfig` from "@/lib/site-config", `BlogPostContent` from "@/components/blog/blog-post-content"
  </action>
  <verify>
- `bun run type-check` passes
- `bun run lint` passes
- `app/blog/[slug]/page.tsx` exists with generateMetadata, generateStaticParams, and page component
- `components/blog/blog-post-content.tsx` exists and uses react-markdown with remark-gfm and rehype-highlight
- JSON-LD script tag is present in the page output
- notFound() is called when post is null (covers drafts, deleted posts)
  </verify>
  <done>
- Blog post detail page renders markdown content with syntax highlighting in prose-width area
- Cover image displays full-width above the content
- Meta info (category, date, reading time) appears below the title
- JSON-LD BlogPosting schema is embedded
- Back link navigates to /blog
- Bottom CTA section with book-a-call appears
- Draft posts return 404
- SEO metadata (title, description, OG tags) is generated per post
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OG image, update sitemap, and add Blog nav link</name>
  <files>
    app/blog/[slug]/opengraph-image.tsx
    app/sitemap.ts
    components/navigation/site-nav.tsx
  </files>
  <action>
1. **Create `app/blog/[slug]/opengraph-image.tsx`** - Dynamic OG image:
- Uses `ImageResponse` from `next/og`
- Export `size = { width: 1200, height: 630 }` and `contentType = "image/png"`
- Fetch post via `fetchQuery(api.blogPosts.getBySlug, { slug })` using params
- If post not found, render a generic fallback with "Jon Gerton" branding
- Design:
  - Background: gradient from dark blue (#003F75 corporate-blue) to tech blue (#2884BD)
  - White text
  - Large headline: post.title (truncate if too long, max ~80 chars)
  - Category badge pill
  - Bottom: "jpgerton.com" and reading time
  - Use flexbox layout (grid not supported by ImageResponse)
  - Keep font specification simple (use default system fonts - ImageResponse has limited font support)
- Note: ImageResponse only supports a subset of CSS (flexbox, basic text, background, border). No Tailwind, no CSS variables. Use inline styles only.

2. **Update `app/sitemap.ts`** to include blog posts:
- After the existing project pages try/catch block, add a similar block for blog posts:
```typescript
let blogPages: MetadataRoute.Sitemap = [];
try {
  const posts = await fetchQuery(api.blogPosts.listPublished, {});
  blogPages = posts.map((post) => ({
    url: `${BASE_URL}/blog/${post.slug}`,
    lastModified: post.publishedAt ? new Date(post.publishedAt) : new Date(post._creationTime),
    changeFrequency: "monthly" as const,
    priority: 0.7,
  }));
} catch {
  console.warn("Sitemap: Could not fetch blog posts from Convex");
}
```
- Also add the `/blog` list page as a static page:
```typescript
{
  url: `${BASE_URL}/blog`,
  lastModified: new Date(),
  changeFrequency: "weekly",
  priority: 0.8,
},
```
- Add `/blog` entry in the staticPages array (after `/projects`)
- Spread `blogPages` in the return array: `return [...staticPages, ...projectPages, ...blogPages]`

3. **Update `components/navigation/site-nav.tsx`** - Add Blog link:
- Add `{ href: "/blog", label: "Blog" }` to the `navLinks` array
- Insert it after "Projects" (index 2) so the order becomes: Home, Projects, Blog, Services, About, Contact
- This is a one-line change to the array. No other changes needed.
  </action>
  <verify>
- `bun run type-check` passes
- `bun run lint` passes
- `app/blog/[slug]/opengraph-image.tsx` exists and exports default function + size + contentType
- `app/sitemap.ts` includes blog post URLs and /blog list page URL
- `components/navigation/site-nav.tsx` navLinks array includes Blog entry
- OG image uses ImageResponse (not external image service)
  </verify>
  <done>
- Dynamic OG images generate for each blog post with title, category, and branding
- Sitemap includes /blog and all /blog/[slug] URLs with correct lastModified dates
- Site navigation shows Blog link between Projects and Services
- Blog is fully discoverable via navigation, search engines (sitemap), and social media (OG images)
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. `bun run lint` passes
3. Navigate to /blog/[slug] - full blog post renders with formatted markdown
4. Code blocks in markdown show syntax highlighting colors (not plain black text)
5. Cover image shows full-width above content
6. Category badge, date, and reading time display below title
7. Bottom CTA section appears with two buttons
8. Accessing a draft post's slug returns 404
9. View page source: JSON-LD BlogPosting script tag present with correct data
10. Visit /blog/[slug]/opengraph-image - PNG image renders with post title
11. Check sitemap.xml - /blog and /blog/[slug] entries present
12. Site navigation shows Blog link
</verification>

<success_criteria>
- Blog post detail page renders markdown with syntax highlighting in prose-width layout
- Draft posts are not accessible via direct URL (404)
- Each post has unique OG metadata and dynamic OG image
- JSON-LD BlogPosting schema embedded in every post page
- Blog posts appear in sitemap
- Blog link appears in site navigation
- Bottom-of-post CTA drives visitors toward conversion
</success_criteria>

<output>
After completion, create `.planning/phases/17-public-blog-pages/17-02-SUMMARY.md`
</output>
