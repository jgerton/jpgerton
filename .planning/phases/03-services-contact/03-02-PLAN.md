---
phase: 03-services-contact
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - convex/contacts.ts
  - convex/actions.ts
  - convex/convex.config.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email notification on contact form submission"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain (optional) or use onboarding@resend.dev for testing"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "Contact form submission stores in Convex database"
    - "Email notification sent to Jon on new submission"
    - "Honeypot check rejects bot submissions"
  artifacts:
    - path: "convex/contacts.ts"
      provides: "Contact form mutations"
      exports: ["create"]
    - path: "convex/actions.ts"
      provides: "Email sending action"
      contains: "sendContactNotification"
    - path: "convex/convex.config.ts"
      provides: "Resend component configuration"
      contains: "resend"
  key_links:
    - from: "convex/contacts.ts"
      to: "convex/actions.ts"
      via: "scheduler"
      pattern: "ctx.scheduler.runAfter"
    - from: "convex/actions.ts"
      to: "Resend API"
      via: "@convex-dev/resend"
      pattern: "Resend.*sendEmail"
---

<objective>
Create Convex mutations for contact form storage and Resend email notification action.

Purpose: Backend for contact form submissions with automated email alerts to Jon.
Output: Contact submissions stored in database, email notification sent on each submission.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-services-contact/03-CONTEXT.md
@.planning/phases/03-services-contact/03-RESEARCH.md
@.planning/phases/03-services-contact/03-01-SUMMARY.md
@convex/schema.ts
@lib/validations/contact-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact mutations</name>
  <files>convex/contacts.ts</files>
  <action>
Create convex/contacts.ts with mutations for contact form handling:

```typescript
import { v } from "convex/values";
import { mutation } from "./_generated/server";
import { internal } from "./_generated/api";

export const create = mutation({
  args: {
    name: v.string(),
    email: v.string(),
    projectType: v.string(),
    message: v.string(),
    honeypot: v.string(),
  },
  handler: async (ctx, args) => {
    // Honeypot check - reject if filled (bot detection)
    if (args.honeypot !== "") {
      // Silently reject - don't give bots feedback
      return { success: false, error: "submission_rejected" };
    }

    // Basic server-side validation
    if (args.name.length < 2) {
      return { success: false, error: "name_too_short" };
    }
    if (!args.email.includes("@")) {
      return { success: false, error: "invalid_email" };
    }
    if (args.message.length < 10) {
      return { success: false, error: "message_too_short" };
    }

    // Store in database
    const contactId = await ctx.db.insert("contactSubmissions", {
      name: args.name,
      email: args.email,
      projectType: args.projectType,
      message: args.message,
      honeypot: args.honeypot,
      status: "new",
      createdAt: Date.now(),
    });

    // Schedule email notification (runs after mutation commits)
    await ctx.scheduler.runAfter(0, internal.actions.sendContactNotification, {
      contactId,
      name: args.name,
      email: args.email,
      projectType: args.projectType,
      message: args.message,
    });

    return { success: true, contactId };
  },
});
```

Key patterns:
- Honeypot check silently rejects bots
- Server-side validation mirrors Zod schema
- Uses scheduler.runAfter(0, ...) for immediate email dispatch
- Returns structured response for client handling
  </action>
  <verify>
    - `bun run type-check` passes
    - File exports create mutation
  </verify>
  <done>
    - Contact mutation validates and stores submissions
    - Honeypot check blocks bot submissions
    - Email notification scheduled after successful insert
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Resend email action</name>
  <files>convex/convex.config.ts, convex/actions.ts</files>
  <action>
First, create convex/convex.config.ts to register Resend component:

```typescript
import { defineApp } from "convex/server";
import resend from "@convex-dev/resend/convex.config";

const app = defineApp();
app.use(resend);

export default app;
```

Then create convex/actions.ts with the email sending action:

```typescript
"use node";

import { v } from "convex/values";
import { internalAction } from "./_generated/server";
import { Resend } from "@convex-dev/resend";
import { components } from "./_generated/api";

const resend = new Resend(components.resend);

export const sendContactNotification = internalAction({
  args: {
    contactId: v.id("contactSubmissions"),
    name: v.string(),
    email: v.string(),
    projectType: v.string(),
    message: v.string(),
  },
  handler: async (ctx, args) => {
    const projectTypeLabels: Record<string, string> = {
      wordpress: "$500 WordPress Site",
      "custom-web-app": "Custom Web App",
      consulting: "Team Growth Accelerator",
      other: "Other Inquiry",
    };

    const projectLabel = projectTypeLabels[args.projectType] || args.projectType;

    try {
      await resend.sendEmail(ctx, {
        from: "JPGerton Portfolio <notifications@jpgerton.com>",
        to: ["jon@jpgerton.com"], // Replace with actual email
        subject: `New ${projectLabel} inquiry from ${args.name}`,
        html: `
          <h2>New Contact Form Submission</h2>
          <p><strong>Name:</strong> ${escapeHtml(args.name)}</p>
          <p><strong>Email:</strong> <a href="mailto:${escapeHtml(args.email)}">${escapeHtml(args.email)}</a></p>
          <p><strong>Project Type:</strong> ${escapeHtml(projectLabel)}</p>
          <hr />
          <p><strong>Message:</strong></p>
          <p style="white-space: pre-wrap;">${escapeHtml(args.message)}</p>
          <hr />
          <p style="color: #666; font-size: 12px;">
            Submission ID: ${args.contactId}<br />
            Sent from jpgerton.com contact form
          </p>
        `,
      });

      console.log(`Email sent for contact ${args.contactId}`);
    } catch (error) {
      console.error(`Failed to send email for contact ${args.contactId}:`, error);
      // Don't throw - email failure shouldn't fail the contact submission
    }
  },
});

// Simple HTML escaping to prevent XSS in email
function escapeHtml(text: string): string {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
```

Key patterns:
- "use node" directive required for Resend component
- internalAction (not public action) - only callable from mutations
- HTML escaping prevents XSS in email content
- Non-throwing error handling - email failure logged but doesn't break submission
- Project type labels for human-readable email subject
  </action>
  <verify>
    - `bun run type-check` passes
    - `bunx convex dev --once` succeeds (schema + actions compile)
  </verify>
  <done>
    - Resend component configured in convex.config.ts
    - Email action sends formatted notification to Jon
    - HTML escaping prevents XSS vulnerabilities
    - Error handling is graceful (logs but doesn't throw)
  </done>
</task>

</tasks>

<verification>
Run verification:
```bash
bun run type-check
bunx convex dev --once
```

Verify files exist and export correctly:
- convex/contacts.ts exports create mutation
- convex/actions.ts exports sendContactNotification
- convex/convex.config.ts registers Resend component
</verification>

<success_criteria>
1. Contact mutation stores submissions and validates input
2. Honeypot check silently rejects bot submissions
3. Email action sends notification with proper formatting
4. Resend component properly configured
5. All type checks and Convex compilation pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-services-contact/03-02-SUMMARY.md`
</output>
