---
phase: 16-admin-content-management
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - components/admin/case-study-form.tsx
  - components/admin/sortable-case-study-list.tsx
  - components/admin/sortable-case-study-row.tsx
  - app/admin/case-studies/page.tsx
  - app/admin/case-studies/new/page.tsx
  - app/admin/case-studies/[id]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of case studies with status filter tabs (All/Draft/Published)"
    - "Admin can see linked project name per case study row (or 'Unlinked')"
    - "Admin can drag-to-reorder case studies in the list"
    - "Admin can create a new case study with three section editors and metrics"
    - "Admin can edit an existing case study with pre-populated form fields"
    - "Admin can delete a case study with confirmation dialog"
    - "Admin can upload a cover image for case studies"
    - "Admin can add/remove metrics (label + value pairs)"
  artifacts:
    - path: "components/admin/case-study-form.tsx"
      provides: "Case study form with 3 section editors, metrics, image upload, zod validation"
      min_lines: 150
    - path: "components/admin/sortable-case-study-list.tsx"
      provides: "Drag-to-reorder case study table using dnd-kit"
      min_lines: 30
    - path: "components/admin/sortable-case-study-row.tsx"
      provides: "Individual sortable case study row with project link and actions"
      min_lines: 40
    - path: "app/admin/case-studies/page.tsx"
      provides: "Case study list page with filter tabs, sortable list, delete confirmation"
      min_lines: 50
    - path: "app/admin/case-studies/new/page.tsx"
      provides: "Create new case study page"
      min_lines: 20
    - path: "app/admin/case-studies/[id]/edit/page.tsx"
      provides: "Edit case study page with pre-loaded data"
      min_lines: 30
  key_links:
    - from: "app/admin/case-studies/page.tsx"
      to: "convex/caseStudies.ts"
      via: "useQuery(api.caseStudies.list) and useMutation(api.caseStudies.reorder/remove)"
      pattern: "api\\.caseStudies\\.(list|reorder|remove)"
    - from: "components/admin/case-study-form.tsx"
      to: "components/admin/markdown-editor.tsx"
      via: "MarkdownEditor component for 3 section content fields"
      pattern: "MarkdownEditor"
    - from: "components/admin/case-study-form.tsx"
      to: "components/admin/image-upload-zone.tsx"
      via: "ImageUploadZone with case study generateUploadUrl"
      pattern: "ImageUploadZone"
    - from: "app/admin/case-studies/new/page.tsx"
      to: "convex/caseStudies.ts"
      via: "useMutation(api.caseStudies.create)"
      pattern: "api\\.caseStudies\\.create"
    - from: "app/admin/case-studies/[id]/edit/page.tsx"
      to: "convex/caseStudies.ts"
      via: "useQuery(api.caseStudies.getById) and useMutation(api.caseStudies.update)"
      pattern: "api\\.caseStudies\\.(getById|update)"
---

<objective>
Build the complete case study admin interface: sortable list page with status filter tabs showing linked project names, case study form component with three section editors (problem/solution/results), metrics management, and image upload, plus route pages for creating and editing case studies.

Purpose: Addresses CASE-04 (edit/delete case studies) and CASE-05 (drag-to-reorder). Follows blog admin pattern established in Plan 02 for consistency.
Output: 6 new files creating the full case study CRUD admin experience.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-admin-content-management/16-CONTEXT.md
@.planning/phases/16-admin-content-management/16-RESEARCH.md
@.planning/phases/16-admin-content-management/16-01-SUMMARY.md

@components/admin/sortable-project-list.tsx
@components/admin/sortable-project-row.tsx
@components/admin/project-form.tsx
@components/admin/confirm-dialog.tsx
@components/admin/image-upload-zone.tsx
@components/admin/markdown-editor.tsx
@app/admin/projects/page.tsx
@app/admin/projects/new/page.tsx
@app/admin/projects/[id]/edit/page.tsx
@convex/caseStudies.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create case study list page with sortable table and filter tabs</name>
  <files>
    components/admin/sortable-case-study-list.tsx
    components/admin/sortable-case-study-row.tsx
    app/admin/case-studies/page.tsx
  </files>
  <action>
    Replicate the blog list pattern (Plan 02 Task 1) for case studies with these differences.

    **A. Create `components/admin/sortable-case-study-row.tsx`:**

    Follow `sortable-blog-row.tsx` / `sortable-project-row.tsx` pattern. Differences:
    - "use client" directive
    - Export interface `CaseStudy`:
      ```typescript
      export interface CaseStudy {
        _id: Id<"caseStudies">;
        title: string;
        status: "draft" | "published";
        project: { _id: Id<"projects">; name: string; slug: string } | null;
        coverImageUrl: string | null;
        createdAt: number;
      }
      ```
    - Props: `caseStudy: CaseStudy`, `onDelete: () => void`
    - Table row columns:
      1. Drag handle (GripVertical icon)
      2. Title (font-medium)
      3. Project (show `caseStudy.project?.name` or "Unlinked" in muted text) - per user decision
      4. Status (Badge - `default` for published, `outline` for draft)
      5. Date (format createdAt)
      6. Actions: Edit (Link to `/admin/case-studies/${caseStudy._id}/edit`) + Delete (triggers onDelete)
    - ConfirmDialog for delete: `Are you sure you want to delete "${caseStudy.title}"? This action cannot be undone.`

    **B. Create `components/admin/sortable-case-study-list.tsx`:**

    Follow `sortable-blog-list.tsx` / `sortable-project-list.tsx` pattern:
    - "use client" directive
    - Import CaseStudy and SortableCaseStudyRow
    - Props: `caseStudies: CaseStudy[]`, `onReorder: (reordered: CaseStudy[]) => void`, `onDelete: (cs: CaseStudy) => void`
    - Same DndContext + SortableContext setup
    - Table headers: (drag handle), Title, Project, Status, Date, Actions

    **C. Create `app/admin/case-studies/page.tsx`:**

    Follow `app/admin/blog/page.tsx` pattern (from Plan 02):
    - "use client" directive
    - useQuery: `api.caseStudies.list` (returns non-deleted case studies with image URLs and project data)
    - useMutation: `api.caseStudies.reorder` and `api.caseStudies.remove`
    - Filter tabs: All / Draft / Published (same pattern as blog)
    - Global ordering (same as blog - filter for display, reorder globally)
    - handleReorder: `reorder({ caseStudyIds: reorderedStudies.map(cs => cs._id) })` with toast
    - handleDeleteConfirm: `remove({ id: deleteTarget._id })` with toast
    - Empty state: Card with "No case studies yet. Create your first case study!" + link to /admin/case-studies/new
    - Header: "Case Studies" h1 + "New Case Study" button (Plus icon, links to /admin/case-studies/new)
    - ConfirmDialog for delete at bottom
    - Loading state when data === undefined

    IMPORTANT: The `reorder` mutation in caseStudies.ts takes `{ caseStudyIds: v.array(v.id("caseStudies")) }`. Use the correct field name.
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - All 3 files exist with correct imports
    - Case study rows show linked project name or "Unlinked"
    - Filter tabs work for All/Draft/Published
  </verify>
  <done>Case study list page renders with filter tabs, linked project names, drag-to-reorder table, and delete confirmation dialog</done>
</task>

<task type="auto">
  <name>Task 2: Create case study form component and route pages</name>
  <files>
    components/admin/case-study-form.tsx
    app/admin/case-studies/new/page.tsx
    app/admin/case-studies/[id]/edit/page.tsx
  </files>
  <action>
    **A. Create `components/admin/case-study-form.tsx`:**

    This form is more complex than blog form due to 3 sections + metrics + project linking.

    - "use client" directive
    - Imports: react-hook-form, zodResolver, zod, MarkdownEditor, ImageUploadZone, Form components, Input, Select, Button, useMutation, useQuery, api, Trash2 icon, Plus icon

    - Export interface `CaseStudyFormData`:
      ```typescript
      export interface CaseStudyFormData {
        title: string;
        slug?: string;
        projectId?: string;
        problemHeading: string;
        problemContent: string;
        solutionHeading: string;
        solutionContent: string;
        resultsHeading: string;
        resultsContent: string;
        metrics: Array<{ label: string; value: string }>;
        coverImageId?: string;
        coverImageAlt?: string;
      }
      ```

    - Zod schema `caseStudyFormSchema`:
      - title: z.string().min(1, "Title is required")
      - slug: z.string().optional()
      - projectId: z.string().optional()
      - problemHeading: z.string().min(1, "Problem heading is required") (default: "The Challenge")
      - problemContent: z.string().min(1, "Problem content is required")
      - solutionHeading: z.string().min(1, "Solution heading is required") (default: "Our Approach")
      - solutionContent: z.string().min(1, "Solution content is required")
      - resultsHeading: z.string().min(1, "Results heading is required") (default: "The Results")
      - resultsContent: z.string().min(1, "Results content is required")
      - metrics: z.array(z.object({ label: z.string().min(1), value: z.string().min(1) }))
      - coverImageId: z.string().optional()
      - coverImageAlt: z.string().optional()
      - `.refine()` for conditional alt text validation (same as blog form)

    - Props:
      ```typescript
      interface CaseStudyFormProps {
        mode: "create" | "edit";
        initialData?: {
          title: string;
          slug: string;
          projectId?: string;
          problemHeading: string;
          problemContent: string;
          solutionHeading: string;
          solutionContent: string;
          resultsHeading: string;
          resultsContent: string;
          metrics: Array<{ label: string; value: string }>;
          coverImageId?: string;
          coverImageAlt?: string;
          coverImageUrl?: string | null;
          status?: "draft" | "published";
        };
        onSubmit: (data: CaseStudyFormData) => Promise<void>;
        onCancel: () => void;
      }
      ```

    - Form layout (vertical flow):
      1. **Title** - Input, required
      2. **Slug** - Input. Same logic as blog: disabled on create (placeholder "Auto-generated on save"), enabled on edit for drafts, disabled for published
      3. **Linked Project** - Select dropdown populated from `useQuery(api.projects.list)`. Options: "None (standalone)" + all projects. This allows linking a case study to a portfolio project. Show project names as options.
      4. **Cover Image** - ImageUploadZone with caseStudies.generateUploadUrl (same pattern as blog)
      5. **Cover Image Alt Text** - Input with description "Required when cover image is present"
      6. **Problem Section:**
         - Heading input (default value "The Challenge")
         - MarkdownEditor for problemContent (height 300)
      7. **Solution Section:**
         - Heading input (default value "Our Approach")
         - MarkdownEditor for solutionContent (height 300)
      8. **Results Section:**
         - Heading input (default value "The Results")
         - MarkdownEditor for resultsContent (height 300)
      9. **Metrics** - Dynamic field array:
         - Each metric has a Label input and Value input side by side
         - "Add Metric" button (Plus icon) appends new row
         - Each row has a Remove button (Trash2 icon)
         - Minimum 0 metrics for drafts (publish mutation requires at least 1)
         - Use `useFieldArray` from react-hook-form for managing the metrics array
         - Actually, since the form uses zod + react-hook-form and metrics is an array, manage it with local state or form.watch + form.setValue:
           ```typescript
           const metrics = form.watch("metrics");
           const addMetric = () => form.setValue("metrics", [...metrics, { label: "", value: "" }]);
           const removeMetric = (index: number) => form.setValue("metrics", metrics.filter((_, i) => i !== index));
           ```

    - Visual section separators: Use `<div className="border-t pt-6 mt-6">` between Problem/Solution/Results sections for clear visual separation (this satisfies the "section dividers" from user decision)

    - Form actions: same as blog (Create Draft / Save Changes + Cancel)

    **B. Create `app/admin/case-studies/new/page.tsx`:**

    Follow `app/admin/blog/new/page.tsx` pattern:
    - "use client" directive
    - useMutation(api.caseStudies.create)
    - handleSubmit: call create with form data. Cast projectId: `data.projectId ? data.projectId as Id<"projects"> : undefined`. Cast coverImageId: `data.coverImageId ? data.coverImageId as Id<"_storage"> : undefined`. Do NOT pass slug (server auto-generates).
    - Toast + router.push("/admin/case-studies") on success
    - Render: max-w-3xl container, h1 "New Case Study", CaseStudyForm mode="create"

    **C. Create `app/admin/case-studies/[id]/edit/page.tsx`:**

    Follow `app/admin/blog/[id]/edit/page.tsx` pattern:
    - "use client" directive
    - useQuery(api.caseStudies.getById, { id: caseStudyId }) - cast params.id as Id<"caseStudies">
    - useMutation(api.caseStudies.update)
    - handleSubmit: call update with { id: caseStudyId, ...data }. Cast projectId and coverImageId appropriately.
    - Loading/Not found states
    - Toast + router.push("/admin/case-studies") on success
    - Render: max-w-3xl container, h1 "Edit Case Study", CaseStudyForm mode="edit" with initialData

    Note on initial data mapping: The getById query returns the full case study object. Map it to the form's initialData shape. The projectId field from the query is `Id<"projects"> | undefined`, which needs to be passed as a string to the form.

    Note on the create mutation args: caseStudies.create takes `{ title, projectId?, problemHeading, problemContent, solutionHeading, solutionContent, resultsHeading, resultsContent, metrics, coverImageId?, coverImageAlt?, slug? }`. All section headings and contents are required strings.
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - All 3 files exist
    - CaseStudyForm has 3 MarkdownEditor instances (problem, solution, results)
    - CaseStudyForm has dynamic metrics array management
    - CaseStudyForm has project linking dropdown populated from useQuery
    - New page creates case study without passing slug
    - Edit page loads case study data and pre-populates all fields including metrics
    - Zod schema validates all required section fields
  </verify>
  <done>
    Case study form renders with 3 section editors, metrics management, project linking, and image upload. New case study page creates drafts. Edit page loads and updates existing case studies. Visual section dividers separate the three content areas.
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` - all TypeScript checks pass across all 6 new files
2. `bun run lint` - no ESLint errors
3. `bun run build` - production build succeeds
4. Case study list at /admin/case-studies renders filter tabs and sortable table
5. Case study rows show linked project name or "Unlinked"
6. Case study form has 3 MarkdownEditor instances with section headings
7. Metrics can be added and removed dynamically
8. Project linking dropdown shows available projects from database
9. Delete confirmation dialog works correctly
10. Drag-to-reorder calls caseStudies.reorder with correct args (caseStudyIds field name)
</verification>

<success_criteria>
- Admin can navigate to /admin/case-studies and see list of case studies
- Admin can filter case studies by All/Draft/Published status tabs
- Admin can see linked project name per row (or "Unlinked")
- Admin can drag-to-reorder case studies and order persists
- Admin can click "New Case Study" and create with 3 section editors
- Admin can edit existing case studies with pre-populated fields including metrics
- Admin can add/remove metrics (label + value pairs)
- Admin can link case study to existing project via dropdown
- Admin can delete case studies with confirmation dialog
- Cover image upload works with case study storage endpoint
- All patterns match blog admin and projects admin for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/16-admin-content-management/16-03-SUMMARY.md`
</output>
