---
phase: 16-admin-content-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/admin/markdown-editor.tsx
  - components/admin/admin-tabs.tsx
  - components/admin/image-upload-zone.tsx
  - lib/site-config.ts
  - app/about/page.tsx
  - app/contact/page.tsx
  - app/services/page.tsx
  - .env.local
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Markdown editor renders in admin pages without SSR hydration errors"
    - "Admin tabs show Blog and Case Studies with count badges"
    - "Image upload works for blog/case study forms (not just projects)"
    - "Calendly URL comes from site-config.ts backed by env variable"
  artifacts:
    - path: "components/admin/markdown-editor.tsx"
      provides: "Code-split markdown editor wrapper with tabbed edit/preview"
      min_lines: 20
    - path: "components/admin/admin-tabs.tsx"
      provides: "Updated admin navigation with Blog, Case Studies tabs and count badges"
      contains: "Blog"
    - path: "components/admin/image-upload-zone.tsx"
      provides: "Configurable upload zone supporting blog/case study upload URLs"
      contains: "generateUploadUrl"
    - path: "lib/site-config.ts"
      provides: "Calendly discovery call URL from env variable"
      contains: "calendly"
  key_links:
    - from: "components/admin/markdown-editor.tsx"
      to: "@uiw/react-md-editor"
      via: "next/dynamic import with ssr: false"
      pattern: "dynamic.*import.*react-md-editor"
    - from: "components/admin/admin-tabs.tsx"
      to: "convex/blogPosts.ts"
      via: "useQuery for tab count badges"
      pattern: "useQuery.*api\\.blogPosts"
    - from: "components/admin/image-upload-zone.tsx"
      to: "Convex generateUploadUrl"
      via: "configurable mutation prop"
      pattern: "generateUploadUrl"
    - from: "app/about/page.tsx"
      to: "lib/site-config.ts"
      via: "siteConfig.calendly import"
      pattern: "siteConfig\\.calendly"
---

<objective>
Set up shared infrastructure for Phase 16 admin content management: install markdown editor dependency, create reusable MarkdownEditor wrapper component (code-split, SSR-safe), update AdminTabs with Blog and Case Studies tabs including count badges, make ImageUploadZone configurable for different content types, and extract hardcoded Calendly URL to site-config.ts backed by environment variable.

Purpose: All subsequent plans (blog admin, case study admin) depend on these shared components. Calendly extraction addresses DEBT-02.
Output: 5 updated files, 1 new component, dependency installed.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-admin-content-management/16-CONTEXT.md
@.planning/phases/16-admin-content-management/16-RESEARCH.md
@components/admin/admin-tabs.tsx
@components/admin/image-upload-zone.tsx
@lib/site-config.ts
@app/about/page.tsx
@app/contact/page.tsx
@app/services/page.tsx
@convex/blogPosts.ts
@convex/caseStudies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependency and create MarkdownEditor wrapper</name>
  <files>
    components/admin/markdown-editor.tsx
  </files>
  <action>
    1. Install @uiw/react-md-editor:
       ```bash
       docker compose exec app bun add @uiw/react-md-editor
       ```
       If Docker is not running, use `bun add @uiw/react-md-editor` directly.

    2. Create `components/admin/markdown-editor.tsx`:
       - "use client" directive
       - Import MDEditor via `next/dynamic` with `ssr: false` to prevent hydration errors (CRITICAL - see research pitfall #1)
       - Wrap in `data-color-mode="light"` div (required by @uiw/react-md-editor for correct theming)
       - Props: `value: string`, `onChange: (value: string | undefined) => void`, `height?: number` (default 400)
       - Set `preview="edit"` as default mode (user switches to preview tab manually)
       - Export as named export: `MarkdownEditor`
       - Add a loading fallback div with "Loading editor..." text for the dynamic import

    Pattern from research:
    ```typescript
    "use client";
    import dynamic from "next/dynamic";

    const MDEditor = dynamic(() => import("@uiw/react-md-editor"), {
      ssr: false,
      loading: () => <div className="h-[400px] border rounded-lg flex items-center justify-center text-muted-foreground">Loading editor...</div>,
    });

    interface MarkdownEditorProps {
      value: string;
      onChange: (value: string | undefined) => void;
      height?: number;
    }

    export function MarkdownEditor({ value, onChange, height = 400 }: MarkdownEditorProps) {
      return (
        <div data-color-mode="light">
          <MDEditor value={value} onChange={onChange} height={height} preview="edit" />
        </div>
      );
    }
    ```
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - File exists at components/admin/markdown-editor.tsx
    - Package @uiw/react-md-editor appears in package.json dependencies
  </verify>
  <done>MarkdownEditor component exists, code-split with ssr:false, typed props, ready for blog and case study forms</done>
</task>

<task type="auto">
  <name>Task 2: Update AdminTabs, ImageUploadZone, and extract Calendly URL</name>
  <files>
    components/admin/admin-tabs.tsx
    components/admin/image-upload-zone.tsx
    lib/site-config.ts
    app/about/page.tsx
    app/contact/page.tsx
    app/services/page.tsx
    .env.local
    .env.example
  </files>
  <action>
    **A. Update AdminTabs** (`components/admin/admin-tabs.tsx`):

    The component must remain a client component ("use client"). Changes:

    1. Import `useQuery` from "convex/react" and `api` from "@/convex/_generated/api"
    2. Update the tabs array to include Blog and Case Studies between Projects and Contacts:
       - Tab order: Dashboard, Projects, Blog, Case Studies, Contacts (per user decision)
       - Blog href: `/admin/blog`
       - Case Studies href: `/admin/case-studies`
    3. Add count badges for Blog and Case Studies tabs:
       - Call `useQuery(api.blogPosts.list, {})` and `useQuery(api.caseStudies.list, {})` at the component level
       - These queries return all non-deleted items (admin queries)
       - Show count conditionally: only when data is loaded (not undefined)
       - Format: `{tab.label}{count !== undefined ? ` (${count})` : ""}`
    4. Keep existing styling and isActive logic unchanged
    5. Update the isActive function to handle new routes correctly - `/admin/blog` and `/admin/case-studies` should use startsWith matching (already handled by existing logic for non-dashboard routes)

    Note: The blogPosts.list and caseStudies.list queries require authentication, which is guaranteed because AdminTabs only renders inside AdminAuthGuard.

    **B. Update ImageUploadZone** (`components/admin/image-upload-zone.tsx`):

    Currently hardcoded to use `api.projects.generateUploadUrl`. Must support blog and case study uploads too.

    1. Add a new prop: `uploadUrlEndpoint` of type that accepts a Convex mutation reference. The simplest approach is to accept a generic mutation function prop:
       ```typescript
       interface ImageUploadZoneProps {
         onUploadComplete: (storageId: string) => void;
         currentImageUrl?: string | null;
         className?: string;
         generateUploadUrl?: () => Promise<string>;  // NEW - optional, defaults to projects
       }
       ```
       Wait - better approach: since the component already uses `useMutation`, pass the API endpoint reference. But Convex mutation types are complex. Simplest: make the component accept a pre-bound `generateUploadUrl` function as a prop. If not provided, fall back to projects endpoint.

       Actually, the cleanest pattern: the parent component calls `useMutation(api.blogPosts.generateUploadUrl)` and passes the resulting function as a prop. Update ImageUploadZone:
       - Add optional prop: `generateUploadUrlFn?: () => Promise<string>`
       - If provided, use it instead of the internal `useMutation(api.projects.generateUploadUrl)`
       - If not provided, keep existing behavior (backward compatible with project-form.tsx)

    2. Change from drag-and-drop to click-to-upload (user decision):
       - Add `noDrag: true` to useDropzone config (disables drag-and-drop)
       - Keep `noClick: false` (or omit - click is enabled by default)
       - Update the UI text from "Drag and drop an image here, or click to browse" to "Click to upload an image"
       - Update the replacement text from "Drop a new image or click to replace" to "Click to upload a new image"

    3. Keep all other functionality: file type validation, max 1 file, preview, uploading state

    **C. Extract Calendly URL** to site-config.ts:

    1. Update `lib/site-config.ts`:
       - Add a `calendly` property to siteConfig:
         ```typescript
         calendly: {
           discoveryCallUrl: process.env.NEXT_PUBLIC_CALENDLY_URL || "https://calendly.com/jongerton/discovery-call",
         },
         ```
       - Keep all existing properties unchanged

    2. Update `app/about/page.tsx`:
       - Add import: `import { siteConfig } from "@/lib/site-config";`
       - Replace `const CALENDLY_URL = "https://calendly.com/jongerton/discovery-call";` with `const CALENDLY_URL = siteConfig.calendly.discoveryCallUrl;`
       - All references to CALENDLY_URL in the file remain unchanged

    3. Update `app/contact/page.tsx`:
       - Same pattern: import siteConfig, replace hardcoded constant

    4. Update `app/services/page.tsx`:
       - Same pattern: import siteConfig, replace hardcoded constant

    5. Update `.env.local`:
       - Add line: `NEXT_PUBLIC_CALENDLY_URL=https://calendly.com/jongerton/discovery-call`
       - Do NOT remove any existing variables

    6. Update `.env.example`:
       - Add line: `NEXT_PUBLIC_CALENDLY_URL=https://calendly.com/jongerton/discovery-call`
       - Do NOT remove any existing variables

    IMPORTANT: Do NOT modify or break the existing ProjectForm usage of ImageUploadZone. The changes must be backward compatible.
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - `bun run build` succeeds (ensures no SSR issues with AdminTabs useQuery calls - these are client components behind auth guard)
    - Grep for hardcoded "calendly.com/jongerton" in app/ directory returns 0 matches (all extracted to site-config.ts)
    - AdminTabs has 5 tabs: Dashboard, Projects, Blog, Case Studies, Contacts
    - ImageUploadZone accepts optional generateUploadUrlFn prop
  </verify>
  <done>
    AdminTabs shows 5 tabs with Blog/Case Studies count badges. ImageUploadZone supports configurable upload endpoints. Calendly URL extracted to site-config.ts with env variable fallback in all 3 page files.
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` - all TypeScript checks pass
2. `bun run lint` - no ESLint errors
3. `bun run build` - production build succeeds (critical: AdminTabs with useQuery must work)
4. grep for hardcoded Calendly URL in app/ returns zero results
5. package.json includes @uiw/react-md-editor
6. MarkdownEditor uses dynamic import with ssr: false
7. AdminTabs shows Blog and Case Studies tabs
8. ImageUploadZone backward compatible (ProjectForm still works without passing generateUploadUrlFn)
</verification>

<success_criteria>
- @uiw/react-md-editor installed and MarkdownEditor wrapper component created with code-splitting
- AdminTabs updated with Blog and Case Studies tabs including reactive count badges
- ImageUploadZone supports configurable upload URL for different content types
- Calendly URL extracted from 3 page files to site-config.ts + env variable
- All existing admin functionality unbroken (Projects tab, ProjectForm image upload)
- Type-check, lint, and build all pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-admin-content-management/16-01-SUMMARY.md`
</output>
