---
phase: 16-admin-content-management
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - components/admin/blog-form.tsx
  - components/admin/sortable-blog-list.tsx
  - components/admin/sortable-blog-row.tsx
  - app/admin/blog/page.tsx
  - app/admin/blog/new/page.tsx
  - app/admin/blog/[id]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of blog posts with status filter tabs (All/Draft/Published)"
    - "Admin can drag-to-reorder blog posts in the list"
    - "Admin can create a new blog post with markdown editor and live preview"
    - "Admin can edit an existing blog post with pre-populated form fields"
    - "Admin can delete a blog post with confirmation dialog"
    - "Admin can upload a cover image when creating/editing a blog post"
    - "Cover image alt text is required when an image is present"
    - "Slug is shown but not editable on create (server-generated); editable on edit for drafts"
  artifacts:
    - path: "components/admin/blog-form.tsx"
      provides: "Blog post form with markdown editor, image upload, zod validation"
      min_lines: 100
    - path: "components/admin/sortable-blog-list.tsx"
      provides: "Drag-to-reorder blog post table using dnd-kit"
      min_lines: 30
    - path: "components/admin/sortable-blog-row.tsx"
      provides: "Individual sortable blog row with edit/delete actions"
      min_lines: 40
    - path: "app/admin/blog/page.tsx"
      provides: "Blog list page with filter tabs, sortable list, delete confirmation"
      min_lines: 50
    - path: "app/admin/blog/new/page.tsx"
      provides: "Create new blog post page"
      min_lines: 20
    - path: "app/admin/blog/[id]/edit/page.tsx"
      provides: "Edit blog post page with pre-loaded data"
      min_lines: 30
  key_links:
    - from: "app/admin/blog/page.tsx"
      to: "convex/blogPosts.ts"
      via: "useQuery(api.blogPosts.list) and useMutation(api.blogPosts.reorder/remove)"
      pattern: "api\\.blogPosts\\.(list|reorder|remove)"
    - from: "components/admin/blog-form.tsx"
      to: "components/admin/markdown-editor.tsx"
      via: "MarkdownEditor component for content field"
      pattern: "MarkdownEditor"
    - from: "components/admin/blog-form.tsx"
      to: "components/admin/image-upload-zone.tsx"
      via: "ImageUploadZone with blog generateUploadUrl"
      pattern: "ImageUploadZone"
    - from: "app/admin/blog/new/page.tsx"
      to: "convex/blogPosts.ts"
      via: "useMutation(api.blogPosts.create)"
      pattern: "api\\.blogPosts\\.create"
    - from: "app/admin/blog/[id]/edit/page.tsx"
      to: "convex/blogPosts.ts"
      via: "useQuery(api.blogPosts.getById) and useMutation(api.blogPosts.update)"
      pattern: "api\\.blogPosts\\.(getById|update)"
---

<objective>
Build the complete blog post admin interface: sortable list page with status filter tabs and drag-to-reorder, blog post form component with markdown editor and image upload, and route pages for creating and editing blog posts.

Purpose: Addresses BLOG-02 (edit/delete blog posts), BLOG-07 (markdown editor with live preview). Follows the established Projects admin pattern for consistency.
Output: 6 new files creating the full blog CRUD admin experience.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-admin-content-management/16-CONTEXT.md
@.planning/phases/16-admin-content-management/16-RESEARCH.md
@.planning/phases/16-admin-content-management/16-01-SUMMARY.md

@components/admin/sortable-project-list.tsx
@components/admin/sortable-project-row.tsx
@components/admin/project-form.tsx
@components/admin/confirm-dialog.tsx
@components/admin/image-upload-zone.tsx
@components/admin/markdown-editor.tsx
@app/admin/projects/page.tsx
@app/admin/projects/new/page.tsx
@app/admin/projects/[id]/edit/page.tsx
@convex/blogPosts.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blog list page with sortable table and filter tabs</name>
  <files>
    components/admin/sortable-blog-list.tsx
    components/admin/sortable-blog-row.tsx
    app/admin/blog/page.tsx
  </files>
  <action>
    Replicate the existing SortableProjectList/SortableProjectRow/projects page pattern for blog posts.

    **A. Create `components/admin/sortable-blog-row.tsx`:**

    Follow `sortable-project-row.tsx` pattern exactly. Differences:
    - "use client" directive
    - Interface `BlogPost` with fields: `_id: Id<"blogPosts">`, `title: string`, `status: "draft" | "published"`, `category: "Local Business" | "Technical" | "Announcement"`, `coverImageUrl: string | null`, `readingTime: number`, `createdAt: number`
    - Props: `post: BlogPost`, `onDelete: () => void`
    - Uses `useSortable` hook from @dnd-kit/sortable (same as sortable-project-row)
    - Table row columns:
      1. Drag handle (GripVertical icon, same pattern)
      2. Title (font-medium)
      3. Category (Badge - use `secondary` variant for all categories)
      4. Status (Badge - `default` for published, `outline` for draft)
      5. Date (format createdAt with `new Date(createdAt).toLocaleDateString()`)
      6. Actions: Edit button (Link to `/admin/blog/${post._id}/edit`) + Delete button (triggers onDelete)
    - ConfirmDialog for delete confirmation with text: `Are you sure you want to delete "${post.title}"? This action cannot be undone.`
    - Export the BlogPost interface for reuse

    **B. Create `components/admin/sortable-blog-list.tsx`:**

    Follow `sortable-project-list.tsx` pattern exactly. Differences:
    - "use client" directive
    - Import BlogPost and SortableBlogRow from sibling files
    - Props: `posts: BlogPost[]`, `onReorder: (reorderedPosts: BlogPost[]) => void`, `onDelete: (post: BlogPost) => void`
    - Same DndContext + SortableContext + sensor setup as sortable-project-list
    - Table headers: (drag handle), Title, Category, Status, Date, Actions
    - Uses `verticalListSortingStrategy` and `closestCenter` collision detection

    **C. Create `app/admin/blog/page.tsx`:**

    Follow `app/admin/projects/page.tsx` pattern. Key differences:
    - "use client" directive
    - useQuery: `api.blogPosts.list` (returns all non-deleted posts with image URLs and reading time)
    - useMutation: `api.blogPosts.reorder` and `api.blogPosts.remove`
    - Filter tabs at top: All / Draft / Published (using Button with variant toggle)
      - State: `const [statusFilter, setStatusFilter] = useState<"all" | "draft" | "published">("all")`
      - Filtering: `posts?.filter(p => statusFilter === "all" || p.status === statusFilter)`
      - Each button shows count: `All (${posts?.length ?? 0})`, `Draft (${draftCount})`, `Published (${pubCount})`
    - Global ordering: drag-to-reorder operates on filtered view, but `reorder` mutation takes postIds array and updates only those items' displayOrder (matches existing Projects pattern)
    - handleReorder: call `reorder({ postIds: reorderedPosts.map(p => p._id) })` with toast
    - handleDeleteConfirm: call `remove({ id: deleteTarget._id })` with toast
    - Empty state: Card with "No blog posts yet. Create your first post!" and link to /admin/blog/new
    - Header: "Blog Posts" h1 + "New Post" button (Plus icon, links to /admin/blog/new)
    - ConfirmDialog at bottom for delete (same pattern as projects page)
    - Loading state: "Loading..." div when posts === undefined

    IMPORTANT: The `reorder` mutation in blogPosts.ts takes `{ postIds: v.array(v.id("blogPosts")) }`. Pass the IDs of the filtered/reordered items.
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - All 3 files exist with correct imports
    - Blog page imports SortableBlogList and ConfirmDialog
    - Filter tabs render for All/Draft/Published
  </verify>
  <done>Blog list page renders with filter tabs, drag-to-reorder table, delete confirmation, and navigation to create/edit pages</done>
</task>

<task type="auto">
  <name>Task 2: Create blog form component and route pages</name>
  <files>
    components/admin/blog-form.tsx
    app/admin/blog/new/page.tsx
    app/admin/blog/[id]/edit/page.tsx
  </files>
  <action>
    **A. Create `components/admin/blog-form.tsx`:**

    Follow `project-form.tsx` pattern with these specifics:

    - "use client" directive
    - Import: react-hook-form, zodResolver, zod, MarkdownEditor, ImageUploadZone, Form components (FormField, FormItem, FormLabel, FormControl, FormMessage, FormDescription), Input, Textarea, Select components, Button, useMutation, api
    - Export interface `BlogFormData`:
      ```typescript
      export interface BlogFormData {
        title: string;
        slug?: string;  // Optional on create (server generates), editable on edit for drafts
        excerpt: string;
        content: string;
        category: "Local Business" | "Technical" | "Announcement";
        coverImageId?: string;
        coverImageAlt?: string;
      }
      ```
    - Zod schema `blogFormSchema`:
      - title: z.string().min(1, "Title is required")
      - slug: z.string().optional() (on create, omit to let server generate; on edit, show current slug)
      - excerpt: z.string().min(1, "Excerpt is required").max(300, "Excerpt must be under 300 characters")
      - content: z.string().min(1, "Content is required")
      - category: z.enum(["Local Business", "Technical", "Announcement"])
      - coverImageId: z.string().optional()
      - coverImageAlt: z.string().optional()
      - Add `.refine()` for conditional alt text validation: if coverImageId exists, coverImageAlt must be non-empty

    - Props interface:
      ```typescript
      interface BlogFormProps {
        mode: "create" | "edit";
        initialData?: {
          title: string;
          slug: string;
          excerpt: string;
          content: string;
          category: "Local Business" | "Technical" | "Announcement";
          coverImageId?: string;
          coverImageAlt?: string;
          coverImageUrl?: string | null;
          status?: "draft" | "published";
        };
        onSubmit: (data: BlogFormData) => Promise<void>;
        onCancel: () => void;
      }
      ```

    - Form layout (vertical flow per user decision):
      1. **Title** - Input field, required
      2. **Slug** - Input field. On create mode: disabled with placeholder "Auto-generated on save". On edit mode: enabled but show FormDescription "URL slug (cannot be changed once published)". If initialData.status === "published", make slug field disabled.
      3. **Category** - Select dropdown with three options: Local Business, Technical, Announcement
      4. **Excerpt** - Textarea (3 rows), required, with character count hint
      5. **Cover Image** - ImageUploadZone with blog-specific generateUploadUrl:
         - Call `useMutation(api.blogPosts.generateUploadUrl)` in the form component
         - Pass as `generateUploadUrlFn` prop to ImageUploadZone
         - Show current image from initialData.coverImageUrl
      6. **Cover Image Alt Text** - Input field. Show FormDescription "Required when cover image is present". Only visible/relevant when a cover image exists (but always render the field for simplicity - validation handles requirement).
      7. **Content** - MarkdownEditor component (height 500). This is the main editing area.

    - Form actions:
      - Submit button: "Create Draft" (create mode) or "Save Changes" (edit mode)
      - Cancel button: outline variant
      - Loading state: disable buttons, show "Saving..."

    - handleSubmit: setLoading(true), try/catch, call onSubmit prop, finally setLoading(false)

    **B. Create `app/admin/blog/new/page.tsx`:**

    Follow `app/admin/projects/new/page.tsx` pattern:
    - "use client" directive
    - useRouter, useMutation(api.blogPosts.create)
    - handleSubmit: call create with form data (title, excerpt, content, category, coverImageId, coverImageAlt). Do NOT pass slug (let server auto-generate).
    - On success: toast + router.push("/admin/blog")
    - On error: toast with destructive variant
    - Render: max-w-3xl container (wider than projects form to give markdown editor room), h1 "New Blog Post", BlogForm with mode="create"

    **C. Create `app/admin/blog/[id]/edit/page.tsx`:**

    Follow `app/admin/projects/[id]/edit/page.tsx` pattern:
    - "use client" directive
    - useParams, useRouter
    - useQuery(api.blogPosts.getById, { id: postId }) - cast params.id as Id<"blogPosts">
    - useMutation(api.blogPosts.update)
    - handleSubmit: call update with { id: postId, ...data }. Include slug in the update data (the backend enforces immutability for published posts).
    - Loading state: "Loading..." when post === undefined
    - Not found state: "Blog post not found" when post === null
    - On success: toast + router.push("/admin/blog")
    - Render: max-w-3xl container, h1 "Edit Blog Post", BlogForm with mode="edit" and initialData from query result

    Note on the create mutation args: The blogPosts.create mutation accepts `{ title, excerpt, content, category, coverImageId?, coverImageAlt?, slug? }`. The coverImageId is `v.id("_storage")` type. When passing from the form, cast the string storageId to `Id<"_storage">` using: `coverImageId: data.coverImageId as Id<"_storage"> | undefined`.

    Note on the update mutation args: The blogPosts.update mutation accepts `{ id, title?, excerpt?, content?, category?, coverImageId?, coverImageAlt?, slug? }`. All fields except id are optional. Pass all form fields.
  </action>
  <verify>
    - `bun run type-check` passes
    - `bun run lint` passes
    - All 3 files exist
    - BlogForm uses MarkdownEditor for content field
    - BlogForm uses ImageUploadZone with blog-specific upload URL
    - New page creates draft without passing slug
    - Edit page loads post data and pre-populates form
    - Zod schema has refine() for conditional alt text validation
  </verify>
  <done>
    Blog form component renders with markdown editor, image upload, and zod validation. New blog post page creates drafts. Edit page loads and updates existing posts. Slug auto-generated on create, shown on edit.
  </done>
</task>

</tasks>

<verification>
1. `bun run type-check` - all TypeScript checks pass across all 6 new files
2. `bun run lint` - no ESLint errors
3. `bun run build` - production build succeeds
4. Blog list page at /admin/blog renders filter tabs and sortable table
5. Blog form uses MarkdownEditor component (code-split, no SSR issues)
6. Blog form uses ImageUploadZone with blogPosts.generateUploadUrl
7. Zod validation requires alt text when cover image is present
8. Slug field disabled on create (server-generated), enabled on edit (drafts only)
9. Delete confirmation dialog matches existing pattern from projects
10. Drag-to-reorder calls blogPosts.reorder mutation with correct args
</verification>

<success_criteria>
- Admin can navigate to /admin/blog and see list of blog posts
- Admin can filter posts by All/Draft/Published status tabs
- Admin can drag-to-reorder posts and order persists
- Admin can click "New Post" and create a blog post with markdown content
- Admin can edit existing blog posts with pre-populated fields
- Admin can delete blog posts with confirmation dialog
- Cover image upload works with blog-specific storage endpoint
- Alt text validation fires when image present but alt text blank
- All patterns match existing Projects admin for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/16-admin-content-management/16-02-SUMMARY.md`
</output>
