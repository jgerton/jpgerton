---
phase: 15-content-schema-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "blogPosts table exists in Convex schema with all required fields"
    - "caseStudies table exists in Convex schema with all required fields"
    - "Indexes exist for slug, status+publishedAt, displayOrder, and projectId lookups"
    - "New dependencies (slugify, dayjs, react-markdown, remark-gfm) are installed"
  artifacts:
    - path: "convex/schema.ts"
      provides: "blogPosts and caseStudies table definitions with indexes"
      contains: "blogPosts"
    - path: "package.json"
      provides: "New dependencies for content layer"
      contains: "slugify"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/_generated"
      via: "Convex codegen reads schema and generates typed API"
      pattern: "defineTable"
---

<objective>
Add blogPosts and caseStudies table definitions to the Convex schema and install content layer dependencies.

Purpose: The schema is the foundation that Plan 02 (blog + case study modules) depends on. Without table definitions, no queries or mutations can be written.
Output: Updated convex/schema.ts with two new tables and indexes, plus four new npm packages installed.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-content-schema-backend/15-CONTEXT.md
@.planning/phases/15-content-schema-backend/15-RESEARCH.md
@convex/schema.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install content layer dependencies</name>
  <files>package.json</files>
  <action>
Install four new packages using bun (run inside Docker container or on host if bun is available):

```bash
bun add slugify dayjs react-markdown remark-gfm
```

Expected versions (from research):
- slugify ^1.6.6 (URL-safe slug generation)
- dayjs ^1.11.13 (date formatting for publishedAt display)
- react-markdown ^10.1.0 (markdown rendering, safe by default)
- remark-gfm ^4.0.0 (GitHub Flavored Markdown: tables, strikethrough, autolinks)

Do NOT install rehype-highlight or @uiw/react-md-editor -- those are for Phase 17 and 16 respectively.
  </action>
  <verify>
Run `bun install` to confirm lockfile is clean. Verify package.json contains all four new dependencies.
  </verify>
  <done>package.json lists slugify, dayjs, react-markdown, and remark-gfm in dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Add blogPosts and caseStudies tables to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add two new table definitions to convex/schema.ts, following the exact pattern of the existing `projects` table. Place them AFTER the `contactSubmissions` table definition.

**blogPosts table:**
```typescript
blogPosts: defineTable({
  title: v.string(),
  slug: v.string(),
  excerpt: v.string(),
  content: v.string(),
  coverImageId: v.id("_storage"),
  coverImageAlt: v.string(),
  authorId: v.string(),
  status: v.union(v.literal("draft"), v.literal("published")),
  publishedAt: v.optional(v.number()),
  category: v.union(
    v.literal("Local Business"),
    v.literal("Technical"),
    v.literal("Announcement")
  ),
  displayOrder: v.number(),
  isDeleted: v.boolean(),
  createdAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_status", ["status", "publishedAt"])
  .index("by_order", ["displayOrder"]),
```

Key decisions on blogPosts:
- `coverImageId` is REQUIRED (not optional) -- publishing validation enforced at mutation level, but schema requires it so published posts always have an image. For drafts that don't have an image yet, the create mutation will accept it as optional and store a placeholder or the mutation args will make it optional while the full publish flow requires it. CORRECTION: Make `coverImageId` and `coverImageAlt` optional in schema (`v.optional(v.id("_storage"))` and `v.optional(v.string())`) so drafts can be saved without a cover image. The `publish` mutation will validate these are present before allowing status change to "published".
- `authorId` is `v.string()` matching the return type of `getAuthUserId()`.
- `publishedAt` is optional -- only set when first published, preserved when unpublished.
- `isDeleted` is a boolean for soft delete pattern.
- Compound index `["status", "publishedAt"]` enables efficient "published posts by date" queries.
- No tags field -- categories are sufficient for launch (research recommendation).

**caseStudies table:**
```typescript
caseStudies: defineTable({
  title: v.string(),
  slug: v.string(),
  projectId: v.optional(v.id("projects")),
  problemHeading: v.string(),
  problemContent: v.string(),
  solutionHeading: v.string(),
  solutionContent: v.string(),
  resultsHeading: v.string(),
  resultsContent: v.string(),
  metrics: v.array(
    v.object({
      label: v.string(),
      value: v.string(),
    })
  ),
  coverImageId: v.optional(v.id("_storage")),
  coverImageAlt: v.optional(v.string()),
  authorId: v.string(),
  status: v.union(v.literal("draft"), v.literal("published")),
  publishedAt: v.optional(v.number()),
  displayOrder: v.number(),
  isDeleted: v.boolean(),
  createdAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_project", ["projectId"])
  .index("by_status", ["status", "publishedAt"])
  .index("by_order", ["displayOrder"]),
```

Key decisions on caseStudies:
- `projectId` is optional -- allows case studies for work outside the portfolio (per context decision).
- Section headings are customizable strings (not fixed) -- defaults "The Challenge", "The Approach", "The Impact" will be set in the admin UI (Phase 16), not enforced in schema.
- Metrics are label+value only (no context field) per research recommendation.
- Same coverImage, soft delete, and status patterns as blogPosts.
- `by_project` index enables efficient "case studies for this project" queries.

Add comments above each table definition matching the style of existing comments (e.g., `// Blog posts for content marketing`).

IMPORTANT: Keep all existing table definitions unchanged. Only ADD the two new tables.
  </action>
  <verify>
Run `bun run type-check` from the project root to confirm the schema compiles without TypeScript errors. If Convex dev server is not running, at minimum the type-check should pass for the schema file itself. Run `bun run lint` to ensure no lint errors.
  </verify>
  <done>convex/schema.ts contains blogPosts and caseStudies table definitions with all specified fields, validators, and indexes. Type-check passes.</done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes with no errors
2. `bun run lint` passes with no errors
3. convex/schema.ts contains `blogPosts` table with 13 fields and 3 indexes
4. convex/schema.ts contains `caseStudies` table with 16 fields and 4 indexes
5. package.json contains slugify, dayjs, react-markdown, remark-gfm
</verification>

<success_criteria>
- Schema file compiles and type-checks cleanly
- All fields from the research exactly match the table definitions
- Indexes support the query patterns needed by Plan 02 (by_slug, by_status, by_order, by_project)
- No existing tables modified
- Dependencies installed and lockfile clean
</success_criteria>

<output>
After completion, create `.planning/phases/15-content-schema-backend/15-01-SUMMARY.md`
</output>
