---
phase: 04-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - middleware.ts
  - convex/projects.ts
  - convex/contacts.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected from /admin/* to /login"
    - "Projects can be created, updated, deleted, and reordered via Convex mutations"
    - "Contacts can be listed and their status updated (including bulk archive)"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection for admin routes"
      contains: "matcher"
    - path: "convex/projects.ts"
      provides: "Project CRUD mutations"
      exports: ["create", "update", "remove", "reorder"]
    - path: "convex/contacts.ts"
      provides: "Contact admin queries and mutations"
      exports: ["list", "updateStatus", "archiveBulk"]
  key_links:
    - from: "middleware.ts"
      to: "/login"
      via: "redirect"
      pattern: "redirect.*login"
    - from: "convex/projects.ts"
      to: "convex/auth"
      via: "getAuthUserId"
      pattern: "getAuthUserId"
---

<objective>
Create middleware for route protection and add admin mutations for projects and contacts.

Purpose: Backend foundation for all admin operations - CRUD mutations must exist before UI can use them.
Output: Working route protection and complete admin API.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-dashboard/04-RESEARCH.md
@convex/projects.ts
@convex/contacts.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for admin route protection</name>
  <files>middleware.ts</files>
  <action>
Create middleware.ts in project root:

1. Import NextRequest, NextResponse from next/server

2. Define route patterns:
   - protectedRoutes: ['/admin'] (all /admin/* routes)
   - publicRoutes: ['/', '/login', '/projects', '/services', '/contact', '/about']

3. Middleware function:
   - Check if path starts with /admin (protected)
   - For protected routes: Check for auth session cookie
   - If no valid session on protected route: redirect to /login
   - If authenticated user visits /login: redirect to /admin
   - Otherwise: NextResponse.next()

4. Export config with matcher:
   - Match all routes except static files, images, and API routes
   - Pattern: ['/((?!api|_next/static|_next/image|favicon.ico|.*\\.png$|.*\\.jpg$|.*\\.svg$).*)']

Note: This is an OPTIMISTIC check - the actual secure verification happens in Convex mutations via getAuthUserId(). Middleware is for UX (quick redirects), not security.

For Convex Auth, check the session by looking for the auth token cookie. The exact cookie name depends on Convex Auth version - use ConvexAuthNextjsServerProvider pattern if available, or check for standard session cookie.
  </action>
  <verify>
- middleware.ts exists at project root
- Export default function and config with matcher
- `bun run type-check` passes
  </verify>
  <done>Middleware redirects unauthenticated users from /admin to /login</done>
</task>

<task type="auto">
  <name>Task 2: Add project CRUD and reorder mutations</name>
  <files>convex/projects.ts</files>
  <action>
Add mutations to convex/projects.ts (keep existing queries):

1. Import getAuthUserId from ./auth

2. Add `create` mutation:
   - Args: name, slug, description, descriptionLong?, status, techStack, techCategories, liveUrl?, githubUrl?, featured, screenshotId?
   - Verify auth with getAuthUserId (throw if not authenticated)
   - Auto-set displayOrder to max(existing) + 1
   - Auto-set createdAt to Date.now()
   - Return the new project ID

3. Add `update` mutation:
   - Args: id (project ID), all fields as optional except id
   - Verify auth with getAuthUserId
   - Use ctx.db.patch(id, {...updatedFields})
   - Return success boolean

4. Add `remove` mutation:
   - Args: id (project ID)
   - Verify auth with getAuthUserId
   - Delete from database with ctx.db.delete(id)
   - Note: Also delete associated screenshot from storage if exists
   - Return success boolean

5. Add `reorder` mutation:
   - Args: projectIds (array of project IDs in new order)
   - Verify auth with getAuthUserId
   - Update displayOrder for each project based on array index
   - Use Promise.all for parallel updates
   - Return success boolean

6. Add `generateUploadUrl` mutation:
   - Verify auth with getAuthUserId
   - Return ctx.storage.generateUploadUrl()
   - Used by image upload component

All mutations MUST call getAuthUserId() and throw "Unauthorized" error if not authenticated.
  </action>
  <verify>
- convex/projects.ts exports create, update, remove, reorder, generateUploadUrl
- Each mutation verifies auth before proceeding
- `bun run type-check` passes
  </verify>
  <done>Project CRUD mutations exist with auth verification</done>
</task>

<task type="auto">
  <name>Task 3: Add contact admin queries and mutations</name>
  <files>convex/contacts.ts</files>
  <action>
Add admin functionality to convex/contacts.ts (keep existing create mutation):

1. Import getAuthUserId from ./auth

2. Add `list` query:
   - Verify auth with getAuthUserId (throw if not authenticated)
   - Query all contactSubmissions, exclude archived by default
   - Sort by status priority: unread first, then read, then responded
   - Within each status, sort by createdAt descending (newest first)
   - Return array with all fields

3. Add `listArchived` query:
   - Verify auth with getAuthUserId
   - Query contactSubmissions where status === "archived"
   - Sort by createdAt descending
   - Return array

4. Add `getById` query:
   - Args: id (contact ID)
   - Verify auth with getAuthUserId
   - Return single contact or null

5. Add `updateStatus` mutation:
   - Args: id (contact ID), status ("read" | "responded" | "archived")
   - Verify auth with getAuthUserId
   - Use ctx.db.patch(id, { status })
   - Return success boolean

6. Add `archiveBulk` mutation:
   - Args: ids (array of contact IDs)
   - Verify auth with getAuthUserId
   - Use Promise.all to patch all with status: "archived"
   - Return count of archived

7. Update existing `create` mutation:
   - Change default status from "new" to "unread"

Note: The existing create mutation is PUBLIC (for contact form) - do NOT add auth check there.
  </action>
  <verify>
- convex/contacts.ts exports list, listArchived, getById, updateStatus, archiveBulk
- Admin queries/mutations verify auth
- Public create mutation does NOT require auth
- `bun run type-check` passes
  </verify>
  <done>Contact admin API exists with list, status updates, and bulk archive</done>
</task>

</tasks>

<verification>
- [ ] middleware.ts exists and protects /admin/* routes
- [ ] convex/projects.ts has CRUD mutations (create, update, remove)
- [ ] convex/projects.ts has reorder and generateUploadUrl mutations
- [ ] convex/contacts.ts has list, updateStatus, archiveBulk
- [ ] All admin mutations verify auth with getAuthUserId
- [ ] `bun run type-check` passes
- [ ] `bun run lint` passes
</verification>

<success_criteria>
- Unauthenticated users redirected from /admin/* to /login
- Projects: create, read, update, delete, reorder mutations work
- Contacts: list (sorted by status), updateStatus, archiveBulk mutations work
- All admin operations require authentication
- Type safety maintained
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-dashboard/04-02-SUMMARY.md`
</output>
