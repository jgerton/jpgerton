---
phase: 05-seo-aeo-performance
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-03"]
files_modified:
  - app/layout.tsx
  - components/analytics/web-vitals.tsx
  - components/calendly/calendly-button.tsx
autonomous: true
user_setup:
  - service: google-analytics
    why: "Track page views and conversions"
    env_vars:
      - name: NEXT_PUBLIC_GA_ID
        source: "Google Analytics 4 > Admin > Data Streams > Web > Measurement ID (starts with G-)"
    dashboard_config:
      - task: "Create GA4 property if not exists"
        location: "analytics.google.com > Admin > Create Property"

must_haves:
  truths:
    - "Vercel Analytics tracks Web Vitals automatically on production"
    - "Google Analytics 4 tracks page views when GA_ID is configured"
    - "Calendly embed receives UTM parameters from URL"
    - "Analytics scripts load without blocking page render"
  artifacts:
    - path: "components/analytics/web-vitals.tsx"
      provides: "Web Vitals measurement component"
      exports: ["WebVitals"]
    - path: "app/layout.tsx"
      provides: "Root layout with analytics"
      contains: ["Analytics", "GoogleAnalytics"]
  key_links:
    - from: "app/layout.tsx"
      to: "@vercel/analytics"
      via: "Analytics component"
      pattern: "@vercel/analytics"
    - from: "app/layout.tsx"
      to: "@next/third-parties/google"
      via: "GoogleAnalytics component"
      pattern: "NEXT_PUBLIC_GA_ID"
---

<objective>
Integrate Vercel Analytics, Google Analytics 4, and UTM tracking for Calendly conversions.

Purpose: Enable measurement of site performance (Web Vitals) and user behavior (page views, conversions) to optimize the conversion funnel.
Output: Working analytics integration with Vercel, GA4, and Calendly UTM passthrough.
</objective>

<execution_context>
@C:\Users\jonge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jonge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-seo-aeo-performance/05-RESEARCH.md
@.planning/phases/05-seo-aeo-performance/05-01-SUMMARY.md
@.planning/phases/05-seo-aeo-performance/05-03-SUMMARY.md
@app/layout.tsx
@components/calendly/calendly-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Web Vitals measurement component</name>
  <files>components/analytics/web-vitals.tsx</files>
  <action>
Create a client component that measures and reports Web Vitals:

**components/analytics/web-vitals.tsx:**
```typescript
"use client";

import { useReportWebVitals } from "next/web-vitals";

export function WebVitals() {
  useReportWebVitals((metric) => {
    // Log to console in development
    if (process.env.NODE_ENV === "development") {
      console.log(`[Web Vital] ${metric.name}: ${metric.value}`);
    }

    // Send to Google Analytics if available
    if (typeof window !== "undefined" && window.gtag) {
      window.gtag("event", metric.name, {
        value: Math.round(
          metric.name === "CLS" ? metric.value * 1000 : metric.value
        ),
        event_label: metric.id,
        non_interaction: true,
      });
    }
  });

  return null;
}
```

Also create a types declaration for gtag:

**types/gtag.d.ts:**
```typescript
declare global {
  interface Window {
    gtag: (
      command: "event" | "config" | "js",
      targetId: string,
      config?: Record<string, unknown>
    ) => void;
  }
}

export {};
```

This component:
- Logs Web Vitals (LCP, FID, CLS, TTFB, INP) to console in dev
- Sends metrics to Google Analytics in production
- Converts CLS to milliseconds (multiplied by 1000) for consistency
  </action>
  <verify>
- `bun run type-check` passes
- Component exists and exports WebVitals
- No TypeScript errors with window.gtag
  </verify>
  <done>WebVitals component created with GA4 integration.</done>
</task>

<task type="auto">
  <name>Task 2: Add analytics to root layout</name>
  <files>app/layout.tsx</files>
  <action>
Update app/layout.tsx to include analytics components:

1. Import Analytics from @vercel/analytics/react
2. Import GoogleAnalytics from @next/third-parties/google
3. Import WebVitals component
4. Add components to the body (after children, before closing body tag)

**Add imports:**
```typescript
import { Analytics } from "@vercel/analytics/react";
import { GoogleAnalytics } from "@next/third-parties/google";
import { WebVitals } from "@/components/analytics/web-vitals";
```

**Add to body (AFTER Providers and children):**
```tsx
<body className="font-sans antialiased">
  <WebVitals />
  <Providers>{children}</Providers>
  <Analytics />
  {process.env.NEXT_PUBLIC_GA_ID && (
    <GoogleAnalytics gaId={process.env.NEXT_PUBLIC_GA_ID} />
  )}
</body>
```

Key points:
- WebVitals goes first (measures timing)
- Analytics (Vercel) works automatically on Vercel deployments
- GoogleAnalytics only renders when NEXT_PUBLIC_GA_ID env var is set
- @next/third-parties loads GA4 optimally (after hydration, non-blocking)
  </action>
  <verify>
- `bun run type-check` passes
- `bun run build` succeeds
- No console errors about missing analytics
- In production (with GA_ID), gtag.js loads
  </verify>
  <done>Root layout includes Vercel Analytics, Google Analytics 4, and Web Vitals tracking.</done>
</task>

<task type="auto">
  <name>Task 3: Add UTM parameter passthrough to Calendly</name>
  <files>components/calendly/calendly-button.tsx</files>
  <action>
Update CalendlyButton to capture and pass UTM parameters for conversion tracking:

The existing CalendlyButton uses react-calendly's PopupModal. Update it to:
1. Capture UTM parameters from URL on mount
2. Store in state
3. Pass to Calendly via the utm prop

**Update CalendlyButton component:**

Add UTM extraction logic:
```typescript
const [utmParams, setUtmParams] = useState<{
  utmSource?: string;
  utmMedium?: string;
  utmCampaign?: string;
  utmContent?: string;
  utmTerm?: string;
}>({});

useEffect(() => {
  if (typeof window !== "undefined") {
    const params = new URLSearchParams(window.location.search);
    setUtmParams({
      utmSource: params.get("utm_source") || undefined,
      utmMedium: params.get("utm_medium") || undefined,
      utmCampaign: params.get("utm_campaign") || undefined,
      utmContent: params.get("utm_content") || undefined,
      utmTerm: params.get("utm_term") || undefined,
    });
  }
}, []);
```

Add utm prop to PopupModal:
```tsx
<PopupModal
  url={url}
  rootElement={document.body}
  onModalClose={() => setIsOpen(false)}
  utm={utmParams}
/>
```

This allows tracking conversions by:
- Marketing campaign source (utm_source=google)
- Marketing medium (utm_medium=cpc)
- Campaign name (utm_campaign=spring_sale)

UTM parameters are persisted through the Calendly booking flow and appear in Calendly analytics and integrations.
  </action>
  <verify>
- `bun run type-check` passes
- Visit /services?utm_source=test&utm_medium=manual
- Click Calendly button
- Calendly should receive UTM params (visible in network tab or Calendly dashboard)
  </verify>
  <done>CalendlyButton passes UTM parameters from URL to Calendly for conversion tracking.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `bun run type-check` passes
2. `bun run build` succeeds
3. Local dev: Web Vitals log to console
4. Check network tab for gtag.js loading (when GA_ID set)
5. Vercel Analytics appears in Vercel dashboard after deployment
6. UTM parameters pass through to Calendly booking
</verification>

<success_criteria>
- [ ] components/analytics/web-vitals.tsx exports WebVitals
- [ ] types/gtag.d.ts provides window.gtag types
- [ ] app/layout.tsx includes WebVitals, Analytics, and GoogleAnalytics
- [ ] GoogleAnalytics conditionally renders based on NEXT_PUBLIC_GA_ID
- [ ] CalendlyButton extracts UTM parameters from URL
- [ ] CalendlyButton passes UTM to PopupModal
- [ ] Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-seo-aeo-performance/05-05-SUMMARY.md`
</output>
